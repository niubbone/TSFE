<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Reference - CRM Studio Smart</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }
        
        .breadcrumb {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .breadcrumb a {
            color: white;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .subsection {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .subsection-title {
            font-size: 1.3rem;
            color: #764ba2;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        thead {
            background: #667eea;
            color: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #d63031;
        }
        
        pre {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            border-left: 4px solid #667eea;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        
        .file-tree {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .nav-links {
            display: flex;
            gap: 16px;
            margin: 30px 0;
        }
        
        .nav-link {
            flex: 1;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .nav-link:hover {
            transform: translateY(-2px);
        }
        
        .back-link {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background: #667eea;
            color: white;
        }
        
        @media (max-width: 768px) {
            .content { padding: 20px; }
            .nav-links { flex-direction: column; }
            table { font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="breadcrumb">
                <a href="architecture.html">â† Architettura</a> / Frontend Reference
            </div>
            <h1>ğŸ“— Frontend Reference</h1>
            <p>JavaScript Modules - UI Components - PWA Features</p>
        </div>
        
        <div class="content">
            
            <!-- STRUTTURA FILE -->
            <div class="section">
                <h2 class="section-title">ğŸ“‚ Struttura File Frontend</h2>
                
                <div class="file-tree">
<pre>
Frontend (GitHub Pages)
â”‚
â”œâ”€â”€ ğŸ“„ HTML
â”‚   â””â”€â”€ index.html                   â†’ SPA principale, modals, tabs
â”‚
â”œâ”€â”€ ğŸ¨ CSS
â”‚   â”œâ”€â”€ css/style.css                â†’ Global styles
â”‚   â”œâ”€â”€ css/client.css               â†’ Clienti section
â”‚   â”œâ”€â”€ css/timesheet.css            â†’ Timesheet section
â”‚   â”œâ”€â”€ css/vendite.css              â†’ Vendite section
â”‚   â”œâ”€â”€ css/utilities.css            â†’ Utilities section
â”‚   â””â”€â”€ version-display.css          â†’ Version box styling
â”‚
â”œâ”€â”€ âš™ï¸ JAVASCRIPT MODULES
â”‚   â”œâ”€â”€ main.js                      â†’ App init, tab switching
â”‚   â”œâ”€â”€ config.js                    â†’ API_URL, constants
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“Š DATA & API
â”‚   â”‚   â”œâ”€â”€ client.js                â†’ Gestione clienti (CRUD)
â”‚   â”‚   â”œâ”€â”€ vendite.js               â†’ Vendite module
â”‚   â”‚   â””â”€â”€ endpoints.js             â†’ API endpoints map
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ› ï¸ UTILITIES
â”‚   â”‚   â”œâ”€â”€ dom.js                   â†’ DOM manipulation helpers
â”‚   â”‚   â”œâ”€â”€ utils.js                 â†’ General utilities
â”‚   â”‚   â”œâ”€â”€ format.js                â†’ Data formatting
â”‚   â”‚   â””â”€â”€ interceptors.js          â†’ Request/response interceptors
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“± PWA
â”‚   â”‚   â”œâ”€â”€ service-worker.js        â†’ SW main logic, caching
â”‚   â”‚   â”œâ”€â”€ sw-register.js           â†’ SW registration
â”‚   â”‚   â”œâ”€â”€ version.js               â†’ Version manager
â”‚   â”‚   â””â”€â”€ version-display.js       â†’ Version UI component
â”‚   â”‚
â”‚   â””â”€â”€ manifest.json                â†’ PWA manifest
â”‚
â””â”€â”€ ğŸ–¼ï¸ ASSETS
    â”œâ”€â”€ icons/                       â†’ App icons (PWA)
    â””â”€â”€ docs/                        â†’ Documentation HTML

TOTALE: 9 file .js + 5 file .css + 1 HTML
</pre>
                </div>
            </div>
            
            <!-- MAIN.JS -->
            <div class="section">
                <h2 class="section-title">ğŸš€ main.js - App Initialization</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">ResponsabilitÃ </h3>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>âœ… Inizializzazione applicazione</li>
                        <li>âœ… Tab switching system</li>
                        <li>âœ… Global event listeners</li>
                        <li>âœ… Load initial data (clients, config)</li>
                        <li>âœ… Setup Service Worker</li>
                    </ul>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">Funzioni Chiave</h3>
                    
<pre><code>// App initialization
async function initializeApp() {
  console.log('ğŸš€ Inizializzazione Studio Smart Timesheet...');
  
  // Load initial data
  await loadClients();
  
  // Setup tabs
  setupTabs();
  
  // Show default tab
  switchTab('dashboard');
  
  console.log('âœ… Applicazione inizializzata');
}

// Tab switching
function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  // Update tab buttons
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
}

// Auto-init on DOM ready
document.addEventListener('DOMContentLoaded', initializeApp);
</code></pre>
                </div>
            </div>
            
            <!-- CLIENT.JS -->
            <div class="section">
                <h2 class="section-title">ğŸ‘¥ client.js - Gestione Clienti</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">State Management</h3>
<pre><code>// Global state
window.clients = [];  // Lista clienti cached in-memory

// Load da backend + cache
async function loadClients() {
  const response = await fetch(`${API_URL}?action=get_data`);
  const result = await response.json();
  
  if (result.success) {
    window.clients = result.clients;
    populateClientSelects();
    
    if (result._fromCache) {
      console.log('âš¡ Clienti da cache backend');
    }
  }
}
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">CRUD Operations</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Funzione</th>
                                <th>Descrizione</th>
                                <th>API Call</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>addClient()</code></td>
                                <td>Form submit â†’ validazione â†’ insert</td>
                                <td>?action=add_client</td>
                            </tr>
                            <tr>
                                <td><code>searchClients(query)</code></td>
                                <td>Debounced search (300ms)</td>
                                <td>?action=search_clienti</td>
                            </tr>
                            <tr>
                                <td><code>updateClient(id)</code></td>
                                <td>Modifica cliente esistente</td>
                                <td>?action=update_client</td>
                            </tr>
                            <tr>
                                <td><code>deleteClient(id)</code></td>
                                <td>Elimina cliente (conferma)</td>
                                <td>?action=delete_client</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">Validation Pattern</h3>
<pre><code>// Frontend validation
function validateClientForm() {
  const nome = document.getElementById('client_name').value.trim();
  const email = document.getElementById('client_email').value.trim();
  
  if (!nome) {
    alert('âš ï¸ Nome obbligatorio');
    return false;
  }
  
  // Email regex
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (email && !emailRegex.test(email)) {
    alert('âš ï¸ Email non valida');
    return false;
  }
  
  return true;
}
</code></pre>
                </div>
            </div>
            
            <!-- VENDITE.JS -->
            <div class="section">
                <h2 class="section-title">ğŸ’¼ vendite.js - Vendite Module</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">Tipi Vendita</h3>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>ğŸ“¦ <strong>Pacchetti Ore:</strong> Prepagati con residuo</li>
                        <li>ğŸ“‹ <strong>Canoni:</strong> Abbonamenti periodici</li>
                        <li>âœï¸ <strong>Firme Digitali:</strong> Token/Remota (3 anni)</li>
                    </ul>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">Funzioni Principali</h3>
                    
<pre><code>// Switch tipo vendita
function switchVenditaType(tipo) {
  // Hide all forms
  document.querySelectorAll('.vendita-form').forEach(form => {
    form.style.display = 'none';
  });
  
  // Show selected
  document.getElementById(`form-${tipo}`).style.display = 'block';
}

// Submit vendita
async function submitVendita(tipo) {
  const cliente = document.getElementById('venditaCliente').value;
  
  // Validation
  if (!cliente) {
    alert('âš ï¸ Seleziona un cliente');
    return;
  }
  
  // Build params based on tipo
  let params = `cliente=${encodeURIComponent(cliente)}`;
  
  if (tipo === 'pacchetto') {
    const ore = document.getElementById('vendita-ore').value;
    const importo = document.getElementById('vendita-importo').value;
    params += `&ore_totali=${ore}&importo=${importo}`;
    action = 'insert_pacchetto';
  }
  
  // API call
  const response = await fetch(`${API_URL}?action=${action}&${params}`);
  const result = await response.json();
  
  if (result.success) {
    alert('âœ… Vendita creata!');
    closeModal('vendita-modal');
  }
}
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">Cliente Field - Datalist Pattern</h3>
                    <div class="info-box">
                        <strong>ğŸ’¡ Pattern:</strong> Input con datalist invece di select per ricerca nativa browser
                    </div>
                    
<pre><code><!-- HTML -->
<input type="text" 
       id="venditaCliente" 
       list="vendita_client_list" 
       placeholder="Cerca o seleziona cliente...">
<datalist id="vendita_client_list">
  <!-- Populated by JS -->
</datalist>

// JavaScript - Populate datalist
function loadVenditaClienti() {
  const datalist = document.getElementById('vendita_client_list');
  datalist.innerHTML = '';
  
  window.clients.forEach(cliente => {
    const option = document.createElement('option');
    option.value = cliente.name;
    datalist.appendChild(option);
  });
}
</code></pre>
                </div>
            </div>
            
            <!-- UI COMPONENTS -->
            <div class="section">
                <h2 class="section-title">ğŸ¨ UI Components</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">Modal System</h3>
                    
<pre><code>// Show modal
function showModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.style.display = 'flex';
  
  // Trap focus
  const firstInput = modal.querySelector('input, select, textarea');
  if (firstInput) firstInput.focus();
}

// Close modal
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.style.display = 'none';
  
  // Reset form
  const form = modal.querySelector('form');
  if (form) form.reset();
}

// Close on overlay click
modal.addEventListener('click', (e) => {
  if (e.target === modal) {
    closeModal(modalId);
  }
});

// Close on ESC key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal(modalId);
  }
});
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">Loading States</h3>
                    
<pre><code>// Show loading
function showLoading(buttonId) {
  const btn = document.getElementById(buttonId);
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Caricamento...';
}

// Hide loading
function hideLoading(buttonId, originalText) {
  const btn = document.getElementById(buttonId);
  btn.disabled = false;
  btn.innerHTML = originalText;
}

// Usage
async function saveData() {
  showLoading('save-btn');
  
  try {
    await fetch(API_URL);
    alert('âœ… Salvato!');
  } catch (error) {
    alert('âŒ Errore');
  } finally {
    hideLoading('save-btn', 'Salva');
  }
}
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">Date Picker Integration</h3>
                    
<pre><code>// Native date input (HTML5)
<input type="date" 
       id="data-timesheet" 
       value="${new Date().toISOString().split('T')[0]}"
       max="${new Date().toISOString().split('T')[0]}">

// Format for display
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('it-IT');
}

// Format for API
function formatDateForAPI(dateInput) {
  return dateInput.value; // YYYY-MM-DD
}
</code></pre>
                </div>
            </div>
            
            <!-- STATE MANAGEMENT -->
            <div class="section">
                <h2 class="section-title">ğŸ”„ State Management</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">Global State (window object)</h3>
                    
<pre><code>// In-memory cache
window.clients = [];        // Lista clienti
window.packets = [];        // Pacchetti attivi
window.config = {};         // Configurazione app

// State updates
function updateClientsCache(newClients) {
  window.clients = newClients;
  
  // Update UI elements
  populateClientSelects();
  updateClientStats();
}

// State getters
function getClientById(id) {
  return window.clients.find(c => c.id === id);
}

function getClientByName(name) {
  return window.clients.find(c => c.name === name);
}
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">LocalStorage (Optional)</h3>
                    
<pre><code>// Save to localStorage
function saveToLocalStorage(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

// Load from localStorage
function loadFromLocalStorage(key) {
  const data = localStorage.getItem(key);
  return data ? JSON.parse(data) : null;
}

// Cache pattern
async function loadClientsWithCache() {
  // Try localStorage first
  const cached = loadFromLocalStorage('clients_cache');
  
  if (cached && Date.now() - cached.timestamp < 300000) {
    window.clients = cached.data;
    return;
  }
  
  // Fetch fresh data
  const response = await fetch(`${API_URL}?action=get_data`);
  const result = await response.json();
  
  if (result.success) {
    saveToLocalStorage('clients_cache', {
      data: result.clients,
      timestamp: Date.now()
    });
    window.clients = result.clients;
  }
}
</code></pre>
                </div>
            </div>
            
            <!-- API COMMUNICATION -->
            <div class="section">
                <h2 class="section-title">ğŸ“¡ API Communication</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">Fetch Pattern</h3>
                    
<pre><code>// Standard fetch pattern
async function apiCall(action, params = {}) {
  try {
    // Build URL
    const queryString = new URLSearchParams(params).toString();
    const url = `${API_URL}?action=${action}&${queryString}`;
    
    // Loading state
    showGlobalLoading();
    
    // Fetch
    const response = await fetch(url);
    const result = await response.json();
    
    // Handle response
    if (result.success) {
      return result;
    } else {
      throw new Error(result.error || 'Errore sconosciuto');
    }
    
  } catch (error) {
    console.error('API Error:', error);
    alert(`âŒ Errore: ${error.message}`);
    throw error;
    
  } finally {
    hideGlobalLoading();
  }
}

// Usage
const result = await apiCall('add_client', {
  client_name: 'Mario Rossi',
  client_email: 'mario@example.com'
});
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">Error Handling</h3>
                    
<pre><code>// Retry logic
async function fetchWithRetry(url, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url);
      return await response.json();
    } catch (error) {
      if (i === retries - 1) throw error;
      
      // Wait before retry (exponential backoff)
      await new Promise(resolve => 
        setTimeout(resolve, Math.pow(2, i) * 1000)
      );
    }
  }
}

// Timeout wrapper
function fetchWithTimeout(url, timeout = 30000) {
  return Promise.race([
    fetch(url),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error('Timeout')), timeout)
    )
  ]);
}
</code></pre>
                </div>
            </div>
            
            <!-- PWA FEATURES -->
            <div class="section">
                <h2 class="section-title">âš¡ PWA Features</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">Service Worker</h3>
                    
                    <h4 style="margin: 16px 0 8px;">Cache Strategy</h4>
<pre><code>// Cache-first for static assets
self.addEventListener('fetch', event => {
  if (event.request.url.includes('.css') || 
      event.request.url.includes('.js')) {
    event.respondWith(
      caches.match(event.request)
        .then(response => response || fetch(event.request))
    );
  }
});

// Network-first for API calls
if (event.request.url.includes('script.google.com')) {
  event.respondWith(
    fetch(event.request)
      .catch(() => caches.match(event.request))
  );
}
</code></pre>
                    
                    <h4 style="margin: 16px 0 8px;">Update Detection</h4>
<pre><code>// sw-register.js
navigator.serviceWorker.register('/service-worker.js')
  .then(registration => {
    
    // Check for updates
    registration.addEventListener('updatefound', () => {
      const newWorker = registration.installing;
      
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && 
            navigator.serviceWorker.controller) {
          
          // New version available
          if (confirm('ğŸ“¦ Nuova versione disponibile! Aggiornare?')) {
            window.location.reload();
          }
        }
      });
    });
  });
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">Offline Capability</h3>
                    
<pre><code>// Offline detection
window.addEventListener('online', () => {
  console.log('âœ… Connessione ripristinata');
  syncOfflineData();
});

window.addEventListener('offline', () => {
  console.log('âš ï¸ ModalitÃ  offline');
  showOfflineBanner();
});

// Offline queue
const offlineQueue = [];

function queueForSync(action, data) {
  offlineQueue.push({ action, data, timestamp: Date.now() });
  localStorage.setItem('offline_queue', JSON.stringify(offlineQueue));
}

async function syncOfflineData() {
  const queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
  
  for (const item of queue) {
    try {
      await apiCall(item.action, item.data);
    } catch (error) {
      console.error('Sync failed:', error);
    }
  }
  
  localStorage.removeItem('offline_queue');
}
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">manifest.json</h3>
                    
<pre><code>{
  "name": "CRM Studio Smart",
  "short_name": "CRM",
  "start_url": "/TSFE/",
  "display": "standalone",
  "background_color": "#667eea",
  "theme_color": "#667eea",
  "icons": [
    {
      "src": "icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ],
  "shortcuts": [
    {
      "name": "Nuovo Cliente",
      "url": "/TSFE/?tab=clienti",
      "icons": [{"src": "icons/icon-192.png", "sizes": "192x192"}]
    }
  ]
}
</code></pre>
                </div>
            </div>
            
            <!-- VERSION SYSTEM -->
            <div class="section">
                <h2 class="section-title">ğŸ”¢ Version Management</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">version.js - Single Source of Truth</h3>
                    
<pre><code>// Unico file da modificare per update versione
export const VERSION = '4.0.4';
export const BUILD_DATE = '22/12/2025';

export const CHANGELOG = [
  {
    version: "4.0.4",
    date: "22/12/2025",
    type: "fix",
    changes: [
      "Fix campo cliente vendite",
      "Fix backend parametri GET"
    ]
  }
];

// Auto-export functions
export function getVersionString() {
  return `v${VERSION}`;
}
</code></pre>
                </div>
                
                <div class="subsection">
                    <h3 class="subsection-title">version-display.js - UI Component</h3>
                    
<pre><code>// Inietta box versione dinamicamente
import { VERSION, CHANGELOG } from './version.js';

function initVersionDisplay() {
  const utilitiesTab = document.getElementById('utilities-tab');
  
  // Create box
  const versionBox = document.createElement('div');
  versionBox.innerHTML = `
    <div class="version-card">
      <span class="version-number">${VERSION}</span>
      <!-- ... -->
    </div>
  `;
  
  utilitiesTab.prepend(versionBox);
}

// Auto-init
document.addEventListener('DOMContentLoaded', initVersionDisplay);
</code></pre>
                </div>
            </div>
            
            <!-- NAVIGATION -->
            <div class="nav-links">
                <a href="arc_backend.html" class="nav-link">ğŸ“˜ Backend Reference â†’</a>
                <a href="tech_sheet.html" class="nav-link">âš¡ Quick Reference â†’</a>
            </div>
            
            <div style="text-align: center;">
                <a href="architecture.html" class="back-link">â† Torna al Riepilogo</a>
            </div>
        </div>
    </div>
</body>
</html>
