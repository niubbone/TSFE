<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architettura CRM Studio Smart - Documentazione Dettagliata</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 60px;
        }

        .section-title {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subsection {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .subsection-title {
            font-size: 1.3rem;
            color: #764ba2;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .function-card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .function-name {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .function-desc {
            color: #666;
            margin-bottom: 10px;
        }

        .function-params {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .correlation {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }

        .correlation-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }

        .flow-diagram {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #667eea;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.8;
        }

        .flow-step {
            color: #667eea;
            font-weight: bold;
        }

        .api-endpoint {
            background: #fff3cd;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
            font-family: 'Courier New', monospace;
        }

        .data-flow {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .data-box {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #667eea;
            text-align: center;
        }

        .data-arrow {
            font-size: 2rem;
            color: #667eea;
            text-align: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }

        .badge-frontend {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-backend {
            background: #d4edda;
            color: #155724;
        }

        .badge-both {
            background: #fff3cd;
            color: #856404;
        }

        .badge-critical {
            background: #f8d7da;
            color: #721c24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e74c3c;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö CRM Studio Smart</h1>
            <p>Documentazione Tecnica Dettagliata - Architettura, Funzioni e Correlazioni</p>
        </div>

        <div class="content">

            <!-- ============================================ -->
            <!-- INDICE NAVIGABILE -->
            <!-- ============================================ -->
            <div class="section">
                <h2 class="section-title">üìë Indice</h2>
                <ul style="line-height: 2; font-size: 1.1rem;">
                    <li><a href="#overview">1. Panoramica Sistema</a></li>
                    <li><a href="#structure">2. Struttura File</a></li>
                    <li><a href="#backend">3. Backend (Apps Script)</a></li>
                    <li><a href="#frontend">4. Frontend (JavaScript)</a></li>
                    <li><a href="#flows">5. Flussi Dati Completi</a></li>
                    <li><a href="#api">6. API Endpoints</a></li>
                    <li><a href="#correlations">7. Correlazioni tra File</a></li>
                    <li><a href="#critical">8. Funzioni Critiche</a></li>
                </ul>
            </div>

            <!-- ============================================ -->
            <!-- 1. PANORAMICA SISTEMA -->
            <!-- ============================================ -->
            <div class="section" id="overview">
                <h2 class="section-title">üéØ 1. Panoramica Sistema</h2>
                
                <div class="info-box">
                    <strong>üìä Statistiche Progetto</strong>
                    <ul style="margin-top: 10px;">
                        <li><strong>23 file totali</strong> (~4.075 righe di codice)</li>
                        <li><strong>9 moduli backend</strong> (Google Apps Script)</li>
                        <li><strong>14 moduli frontend</strong> (HTML/CSS/JavaScript)</li>
                        <li><strong>3 tab principali</strong> (Timesheet, Proforma, Utilities)</li>
                    </ul>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">Architettura a 3 Livelli</h3>
                    
                    <div class="data-flow">
                        <div class="data-box">
                            <strong>üñ•Ô∏è Frontend</strong><br>
                            PWA - GitHub Pages<br>
                            HTML + CSS + JS
                        </div>
                        <div class="data-arrow">‚ÜîÔ∏è</div>
                        <div class="data-box">
                            <strong>‚öôÔ∏è Backend</strong><br>
                            Google Apps Script<br>
                            API REST
                        </div>
                    </div>

                    <div class="data-flow">
                        <div class="data-box" style="grid-column: 2;">
                            <strong>üìä Database</strong><br>
                            Google Sheets<br>
                            5 fogli principali
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">Fogli Google Sheets</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Foglio</th>
                                <th>Scopo</th>
                                <th>Colonne Principali</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Clienti</strong></td>
                                <td>Anagrafica clienti</td>
                                <td>ID_Cliente, Nome_Cliente, Email, Indirizzo, P.IVA, ecc.</td>
                            </tr>
                            <tr>
                                <td><strong>Timesheet</strong></td>
                                <td>Ore lavorate</td>
                                <td>ID_Intervento, ID_Cliente, Data, Durata, Tipo, Mod_Addebito, ecc.</td>
                            </tr>
                            <tr>
                                <td><strong>Pacchetti</strong></td>
                                <td>Pacchetti ore prepagati</td>
                                <td>ID_Pacchetto, ID_Cliente, Ore_Totali, Ore_Utilizzate, Stato, ecc.</td>
                            </tr>
                            <tr>
                                <td><strong>Canoni</strong></td>
                                <td>Abbonamenti mensili</td>
                                <td>ID_Canone, ID_Cliente, Importo, Data_Inizio, Stato, ecc.</td>
                            </tr>
                            <tr>
                                <td><strong>RIF (Config)</strong></td>
                                <td>Configurazioni sistema</td>
                                <td>Tipo_Intervento, Mod_Esecuzione, Mod_Addebito, Numero_Proforma, ecc.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- 2. STRUTTURA FILE -->
            <!-- ============================================ -->
            <div class="section" id="structure">
                <h2 class="section-title">üìÅ 2. Struttura File</h2>

                <div class="subsection">
                    <h3 class="subsection-title">Backend (Google Apps Script)</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; line-height: 1.8; white-space: pre;">üìÅ Apps Script Project
‚îÇ
‚îú‚îÄ üìÑ <strong>Code.gs</strong> (~580 righe)
‚îÇ   ‚îú‚îÄ doGet() - Router GET
‚îÇ   ‚îú‚îÄ doPost() - Router POST
‚îÇ   ‚îú‚îÄ convertDateToSheetFormat()
‚îÇ   ‚îú‚îÄ generateInterventoID()
‚îÇ   ‚îî‚îÄ validateClient() ‚≠ê NUOVO
‚îÇ
‚îú‚îÄ üìÑ <strong>Config.gs</strong> (~20 righe)
‚îÇ   ‚îú‚îÄ SPREADSHEET_URL
‚îÇ   ‚îú‚îÄ SHEET NAMES
‚îÇ   ‚îî‚îÄ WEB_APP_EXEC_URL
‚îÇ
‚îú‚îÄ üìÑ <strong>DataService.gs</strong> (~150 righe)
‚îÇ   ‚îú‚îÄ getSpreadsheet()
‚îÇ   ‚îú‚îÄ getClientsList()
‚îÇ   ‚îú‚îÄ getConfigOptions()
‚îÇ   ‚îú‚îÄ getClientData()
‚îÇ   ‚îú‚îÄ getClientEmail()
‚îÇ   ‚îú‚îÄ getClientID()
‚îÇ   ‚îî‚îÄ getTimesheetDaFatturare()
‚îÇ
‚îú‚îÄ üìÑ <strong>EmailService.gs</strong> (~100 righe)
‚îÇ   ‚îú‚îÄ sendEmailToClient()
‚îÇ   ‚îî‚îÄ sendProformaEmail()
‚îÇ
‚îú‚îÄ üìÑ <strong>ProformaService.gs</strong> (~250 righe)
‚îÇ   ‚îú‚îÄ generateAndSendProforma()
‚îÇ   ‚îú‚îÄ createProformaDocument()
‚îÇ   ‚îú‚îÄ getNextProformaNumber()
‚îÇ   ‚îî‚îÄ convertPdfAndSave()
‚îÇ
‚îú‚îÄ üìÑ <strong>PacchettiService.gs</strong> (~200 righe)
‚îÇ   ‚îú‚îÄ getActivePacchetto()
‚îÇ   ‚îú‚îÄ updatePacchetto()
‚îÇ   ‚îî‚îÄ checkPacchettoStatus()
‚îÇ
‚îú‚îÄ üìÑ <strong>CanoniService.gs</strong> (~100 righe)
‚îÇ   ‚îú‚îÄ getActiveCanone()
‚îÇ   ‚îî‚îÄ updateCanone()
‚îÇ
‚îú‚îÄ üìÑ <strong>Utilities.gs</strong> (~200 righe)
‚îÇ   ‚îú‚îÄ writeLog()
‚îÇ   ‚îú‚îÄ getLogs()
‚îÇ   ‚îú‚îÄ cleanOldLogs()
‚îÇ   ‚îú‚îÄ generateBackup()
‚îÇ   ‚îú‚îÄ testConnection()
‚îÇ   ‚îî‚îÄ checkDataIntegrity()
‚îÇ
‚îî‚îÄ üìÑ <strong>Helpers.gs</strong> (~50 righe)
    ‚îú‚îÄ formatCurrency()
    ‚îú‚îÄ convertDurationToHours()
    ‚îî‚îÄ sanitizeInput()</div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">Frontend (GitHub Repository)</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; line-height: 1.8; white-space: pre;">üìÅ Repository GitHub
‚îÇ
‚îú‚îÄ üìÑ <strong>index.html</strong> (~650 righe)
‚îÇ   ‚îú‚îÄ Tab Timesheet
‚îÇ   ‚îú‚îÄ Tab Proforma
‚îÇ   ‚îî‚îÄ Tab Utilities
‚îÇ
‚îú‚îÄ üìÅ <strong>css/</strong>
‚îÇ   ‚îú‚îÄ main.css (150 righe)
‚îÇ   ‚îú‚îÄ tabs.css (100 righe)
‚îÇ   ‚îú‚îÄ forms.css (180 righe)
‚îÇ   ‚îú‚îÄ tables.css (100 righe)
‚îÇ   ‚îú‚îÄ modals.css (80 righe)
‚îÇ   ‚îî‚îÄ utilities.css (150 righe)
‚îÇ
‚îú‚îÄ üìÅ <strong>js/</strong>
‚îÇ   ‚îú‚îÄ <strong>config.js</strong> (20 righe)
‚îÇ   ‚îÇ   ‚îî‚îÄ CONFIG: URL, APP_NAME, VERSION
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ <strong>api.js</strong> (~150 righe)
‚îÇ   ‚îÇ   ‚îú‚îÄ getClientsAndConfig()
‚îÇ   ‚îÇ   ‚îú‚îÄ addClient()
‚îÇ   ‚îÇ   ‚îú‚îÄ getTimesheetDaFatturare()
‚îÇ   ‚îÇ   ‚îú‚îÄ generateProforma()
‚îÇ   ‚îÇ   ‚îî‚îÄ getLastWarning()
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ <strong>timesheet.js</strong> (~350 righe) ‚≠ê MODIFICATO
‚îÇ   ‚îÇ   ‚îú‚îÄ initTimesheet()
‚îÇ   ‚îÇ   ‚îú‚îÄ loadFormData()
‚îÇ   ‚îÇ   ‚îú‚îÄ handleFormSubmit()
‚îÇ   ‚îÇ   ‚îú‚îÄ setupClientValidation() ‚≠ê NUOVO
‚îÇ   ‚îÇ   ‚îú‚îÄ openAddClientModal()
‚îÇ   ‚îÇ   ‚îî‚îÄ saveNewClient()
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ <strong>proforma.js</strong> (~350 righe)
‚îÇ   ‚îÇ   ‚îú‚îÄ initProforma()
‚îÇ   ‚îÇ   ‚îú‚îÄ loadTimesheetForClient()
‚îÇ   ‚îÇ   ‚îú‚îÄ displayTimesheetTable()
‚îÇ   ‚îÇ   ‚îú‚îÄ proceedToStep3()
‚îÇ   ‚îÇ   ‚îî‚îÄ generateProformaFinal()
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ <strong>utilities.js</strong> (~120 righe)
‚îÇ   ‚îÇ   ‚îú‚îÄ initUtilities()
‚îÇ   ‚îÇ   ‚îî‚îÄ downloadFrontendBackup()
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ <strong>utils.js</strong> (~100 righe)
‚îÇ   ‚îÇ   ‚îú‚îÄ formatDate()
‚îÇ   ‚îÇ   ‚îú‚îÄ formatCurrency()
‚îÇ   ‚îÇ   ‚îú‚îÄ showNotification()
‚îÇ   ‚îÇ   ‚îî‚îÄ getTodayDate()
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ <strong>main.js</strong> (~80 righe)
‚îÇ       ‚îú‚îÄ switchTab()
‚îÇ       ‚îú‚îÄ setupTabs()
‚îÇ       ‚îî‚îÄ DOMContentLoaded
‚îÇ
‚îî‚îÄ üìÑ <strong>manifest.json</strong> (PWA config)</div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- 3. BACKEND - FUNZIONI DETTAGLIATE -->
            <!-- ============================================ -->
            <div class="section" id="backend">
                <h2 class="section-title">‚öôÔ∏è 3. Backend - Funzioni Dettagliate</h2>

                <!-- Code.gs -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ Code.gs - Router Principale</h3>

                    <div class="function-card">
                        <div class="function-name">doGet(e)</div>
                        <span class="badge badge-backend">Backend</span>
                        <span class="badge badge-critical">Critico</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Router per tutte le richieste GET dall'applicazione frontend.<br>
                            <strong>Gestisce:</strong>
                            <ul style="margin-top: 10px;">
                                <li><code>?action=get_data</code> - Carica clienti e configurazioni</li>
                                <li><code>?action=add_client</code> - Aggiunge nuovo cliente</li>
                                <li><code>?action=get_timesheet_da_fatturare</code> - Recupera timesheet da proformare</li>
                                <li><code>?action=generate_proforma</code> - Genera PDF proforma</li>
                                <li><code>?action=get_logs</code> - Recupera log di sistema</li>
                                <li><code>?action=clean_logs</code> - Pulisce log vecchi</li>
                                <li><code>?action=backup</code> - Genera backup metadata</li>
                                <li><code>?action=test_connection</code> - Test connessione</li>
                                <li><code>?action=check_integrity</code> - Verifica integrit√† dati</li>
                                <li><code>?action=get_last_warning</code> - Recupera ultimo warning pacchetti</li>
                            </ul>
                        </div>
                        <div class="function-params">
<strong>Parametri:</strong> e.parameter.action (string)
<strong>Return:</strong> ContentService (JSON) o HtmlService
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">doPost(e)</div>
                        <span class="badge badge-backend">Backend</span>
                        <span class="badge badge-critical">Critico</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Gestisce l'inserimento di un nuovo timesheet dal form.<br>
                            <strong>Processo:</strong>
                            <ol style="margin-top: 10px;">
                                <li>üö® <strong>Valida cliente</strong> con <code>validateClient()</code></li>
                                <li>Genera ID_Intervento automatico</li>
                                <li>Se "Scala da pacchetto" ‚Üí Aggiorna pacchetto</li>
                                <li>Scrive riga nel foglio Timesheet</li>
                                <li>Invia email riepilogo (opzionale)</li>
                                <li>Salva warning se necessario</li>
                            </ol>
                        </div>
                        <div class="function-params">
<strong>Parametri:</strong> e.parameter (form data)
  - client (string) ‚ö†Ô∏è VALIDATO
  - date (YYYY-MM-DD)
  - duration (string)
  - tipo_intervento, mod_esecuzione, mod_addebito
  - description, send_email
<strong>Return:</strong> HtmlService con Success o Error
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiama:</div>
                            <code>validateClient()</code> ‚≠ê NUOVO<br>
                            <code>generateInterventoID()</code><br>
                            <code>getActivePacchetto()</code> (se scala da pacchetto)<br>
                            <code>updatePacchetto()</code> (se scala da pacchetto)<br>
                            <code>sendEmailToClient()</code> (se send_email = true)<br>
                            <code>writeLog()</code>
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">validateClient(clientName)</div>
                        <span class="badge badge-backend">Backend</span>
                        <span class="badge badge-critical">‚≠ê NUOVA</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Valida che un cliente esista nel foglio Clienti PRIMA di salvare.<br>
                            <strong>Importanza:</strong> CRITICA - Impedisce inserimenti con clienti non validi.<br>
                            <strong>Processo:</strong>
                            <ol style="margin-top: 10px;">
                                <li>Verifica che clientName non sia vuoto</li>
                                <li>Legge tutti i nomi dalla colonna B del foglio Clienti</li>
                                <li>Cerca match esatto (case-sensitive)</li>
                                <li>Se trovato: restituisce ID_Cliente</li>
                                <li>Se non trovato: logga errore e rifiuta</li>
                            </ol>
                        </div>
                        <div class="function-params">
<strong>Parametri:</strong> clientName (string)
<strong>Return:</strong> { valid: boolean, clientId: string, error: string }

<strong>Esempio Success:</strong>
{ valid: true, clientId: "C_001", clientName: "Mario Rossi" }

<strong>Esempio Error:</strong>
{ valid: false, error: "Cliente non esiste nel database" }
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiamata da:</div>
                            <code>doPost()</code> - Prima di ogni inserimento timesheet
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiama:</div>
                            <code>getSpreadsheet()</code><br>
                            <code>writeLog()</code> - Log di SUCCESS o ERROR
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">generateInterventoID(sheet)</div>
                        <span class="badge badge-backend">Backend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Genera automaticamente ID_Intervento progressivo nel formato <code>I_YYYY_###</code>.<br>
                            <strong>Logica:</strong> Legge tutti gli ID esistenti, trova il massimo dell'anno corrente, incrementa di 1.
                        </div>
                        <div class="function-params">
<strong>Parametri:</strong> sheet (Sheet object)
<strong>Return:</strong> string (es. "I_2025_042")
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">convertDateToSheetFormat(dateString)</div>
                        <span class="badge badge-backend">Backend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Converte data da formato ISO (YYYY-MM-DD) a Date object per Google Sheets.
                        </div>
                    </div>
                </div>

                <!-- DataService.gs -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ DataService.gs - Accesso Dati</h3>

                    <div class="function-card">
                        <div class="function-name">getClientsList()</div>
                        <span class="badge badge-backend">Backend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Restituisce array di tutti i clienti dal foglio Clienti.<br>
                            <strong>Struttura:</strong> <code>[{ name: "...", email: "..." }, ...]</code>
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiamata da:</div>
                            <code>doGet(action=get_data)</code> ‚Üí Frontend per popolare dropdown
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">getConfigOptions()</div>
                        <span class="badge badge-backend">Backend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Legge configurazioni dal foglio RIF (tipo intervento, modalit√† esecuzione, ecc.).
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiamata da:</div>
                            <code>doGet(action=get_data)</code> ‚Üí Frontend per popolare select
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">getClientID(clientName)</div>
                        <span class="badge badge-backend">Backend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Cerca ID_Cliente dato il nome (VLOOKUP-like).<br>
                            <strong>‚ö†Ô∏è DEPRECATO:</strong> Ora sostituito da <code>validateClient()</code> in doPost.
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">getTimesheetDaFatturare(clientName)</div>
                        <span class="badge badge-backend">Backend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Recupera tutti i timesheet con Mod_Addebito = "Da fatturare" per un cliente.
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiamata da:</div>
                            <code>doGet(action=get_timesheet_da_fatturare)</code> ‚Üí Tab Proforma
                        </div>
                    </div>
                </div>

                <!-- ProformaService.gs -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ ProformaService.gs - Generazione Proforma</h3>

                    <div class="function-card">
                        <div class="function-name">generateAndSendProforma(clientData, timesheet, causale, applicaQuota)</div>
                        <span class="badge badge-backend">Backend</span>
                        <span class="badge badge-critical">Critico</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Funzione principale per generare PDF proforma e inviarlo via email.<br>
                            <strong>Processo:</strong>
                            <ol style="margin-top: 10px;">
                                <li>Crea documento da template</li>
                                <li>Popola dati cliente e timesheet</li>
                                <li>Calcola totali (imponibile, IVA, ritenuta)</li>
                                <li>Genera numero proforma progressivo</li>
                                <li>Converte in PDF</li>
                                <li>Salva su Drive</li>
                                <li>Invia email con allegato</li>
                                <li>Aggiorna Mod_Addebito dei timesheet in "Fatturato"</li>
                            </ol>
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiama:</div>
                            <code>createProformaDocument()</code><br>
                            <code>getNextProformaNumber()</code><br>
                            <code>convertPdfAndSave()</code><br>
                            <code>sendProformaEmail()</code>
                        </div>
                    </div>
                </div>

                <!-- PacchettiService.gs -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ PacchettiService.gs - Gestione Pacchetti</h3>

                    <div class="function-card">
                        <div class="function-name">getActivePacchetto(clientID)</div>
                        <span class="badge badge-backend">Backend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Recupera il pacchetto ATTIVO per un cliente (se esiste).<br>
                            <strong>Criteri:</strong> Stato = "ATTIVO", Ore_Residue > 0
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">updatePacchetto(pacchetto, oreUtilizzate)</div>
                        <span class="badge badge-backend">Backend</span>
                        <span class="badge badge-critical">Critico</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Scala ore da un pacchetto e aggiorna lo stato.<br>
                            <strong>Gestisce:</strong>
                            <ul style="margin-top: 10px;">
                                <li>Incrementa Ore_Utilizzate</li>
                                <li>Ricalcola Ore_Residue (formula Google Sheets)</li>
                                <li>Cambia Stato in "TERMINATO" se ore finite</li>
                                <li>Cambia Stato in "OVER" se ore superate</li>
                                <li>Genera alert per l'utente</li>
                            </ul>
                        </div>
                        <div class="function-params">
<strong>Return:</strong> { 
  success: boolean,
  oreUtilizzate: number,
  oreResidue: number,
  stato: string,
  alert: { tipo: string, messaggio: string }
}
                        </div>
                    </div>
                </div>

                <!-- Utilities.gs -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ Utilities.gs - Sistema di Logging</h3>

                    <div class="function-card">
                        <div class="function-name">writeLog(level, action, message, data)</div>
                        <span class="badge badge-backend">Backend</span>
                        <span class="badge badge-critical">Essenziale</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Scrive un log nel foglio System_Log per tracciabilit√†.<br>
                            <strong>Livelli:</strong> INFO, WARNING, ERROR, SUCCESS<br>
                            <strong>Registra:</strong> Timestamp, Level, Action, Message, User, Data (JSON)
                        </div>
                        <div class="function-params">
<strong>Esempio:</strong>
writeLog('ERROR', 'VALIDATE_CLIENT', 'Cliente non trovato', {
  clientName: 'Test',
  attemptedBy: 'user@email.com'
});
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiamata da:</div>
                            TUTTE le funzioni critiche:<br>
                            <code>doPost()</code>, <code>validateClient()</code>, <code>updatePacchetto()</code>, ecc.
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">getLogs(limit)</div>
                        <span class="badge badge-backend">Backend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Recupera gli ultimi N log dal foglio System_Log.<br>
                            <strong>Ordinamento:</strong> Dal pi√π recente al pi√π vecchio
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiamata da:</div>
                            <code>doGet(action=get_logs)</code> ‚Üí Tab Utilities
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- 4. FRONTEND - FUNZIONI DETTAGLIATE -->
            <!-- ============================================ -->
            <div class="section" id="frontend">
                <h2 class="section-title">üñ•Ô∏è 4. Frontend - Funzioni Dettagliate</h2>

                <!-- timesheet.js -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ timesheet.js - Gestione Inserimento</h3>

                    <div class="function-card">
                        <div class="function-name">initTimesheet()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Inizializza il tab Timesheet all'avvio.<br>
                            <strong>Chiamate:</strong>
                            <ol style="margin-top: 10px;">
                                <li><code>loadFormData()</code> - Carica clienti e config</li>
                                <li><code>setupFormSubmit()</code> - Attiva listener submit</li>
                                <li><code>setTodayDate()</code> - Imposta data odierna</li>
                                <li><code>setupSelectFocus()</code> - Gestione placeholder</li>
                                <li><code>setupClientValidation()</code> ‚≠ê NUOVO</li>
                            </ol>
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">loadFormData()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <span class="badge badge-critical">Critico</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Carica clienti e configurazioni dal backend.<br>
                            <strong>Processo:</strong>
                            <ol style="margin-top: 10px;">
                                <li>Chiama API <code>getClientsAndConfig()</code></li>
                                <li>Salva in <code>window.clients</code> e <code>window.config</code></li>
                                <li>‚≠ê RESET campo cliente (cancella cache)</li>
                                <li>Popola datalist clienti</li>
                                <li>Popola select configurazioni</li>
                            </ol>
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiama API:</div>
                            <code>GET ?action=get_data</code> ‚Üí Backend <code>doGet()</code>
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">setupClientValidation()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <span class="badge badge-critical">‚≠ê NUOVA</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Attiva validazione real-time del campo cliente.<br>
                            <strong>Comportamento:</strong>
                            <ul style="margin-top: 10px;">
                                <li>Evento <code>input</code>: Controlla se nome √® in <code>window.clients</code></li>
                                <li>‚úÖ Valido: Bordo verde</li>
                                <li>‚ùå Non valido: Bordo rosso</li>
                                <li>Evento <code>blur</code>: Reset bordo dopo 2 secondi</li>
                            </ul>
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">handleFormSubmit(event)</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <span class="badge badge-critical">‚≠ê CRITICO</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Gestisce il submit del form timesheet.<br>
                            <strong>‚≠ê VALIDAZIONE AGGIUNTA:</strong>
                            <ol style="margin-top: 10px;">
                                <li>üö® <strong>Verifica cliente valido</strong> (cerca in window.clients)</li>
                                <li>Se NON valido: <code>event.preventDefault()</code> + errore</li>
                                <li>Se valido: procede con submit normale</li>
                                <li>Mostra "Salvataggio in corso..."</li>
                                <li>Attende risposta iframe</li>
                                <li>Recupera warning pacchetti (se presenti)</li>
                                <li>Mostra notifica successo</li>
                                <li>Reset form</li>
                            </ol>
                        </div>
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è IMPORTANTE:</strong> La validazione frontend √® la PRIMA linea di difesa. Il backend ha una seconda validazione in <code>validateClient()</code>.
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">saveNewClient()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Aggiunge un nuovo cliente dal modal.<br>
                            <strong>Processo:</strong>
                            <ol style="margin-top: 10px;">
                                <li>Chiama API <code>addClient()</code></li>
                                <li>‚≠ê <strong>Forza refresh completo</strong> con <code>loadFormData()</code></li>
                                <li>Popola automaticamente campo cliente con nuovo nome</li>
                                <li>Chiude modal</li>
                            </ol>
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiama API:</div>
                            <code>GET ?action=add_client</code> ‚Üí Backend <code>doGet()</code>
                        </div>
                    </div>
                </div>

                <!-- proforma.js -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ proforma.js - Generazione Proforma</h3>

                    <div class="function-card">
                        <div class="function-name">loadTimesheetForClient()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Carica timesheet da fatturare per il cliente selezionato.<br>
                            <strong>Step:</strong> Cliente selezionato ‚Üí Step 2 (selezione timesheet)
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiama API:</div>
                            <code>GET ?action=get_timesheet_da_fatturare</code>
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">proceedToStep3()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Passa allo Step 3 (riepilogo e generazione).<br>
                            <strong>Calcola:</strong> Periodo timesheet, causale suggerita, totali
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">generateProformaFinal()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <span class="badge badge-critical">Critico</span>
                        <div class="function-desc">
                            <strong>Scopo:</strong> Genera e invia la proforma finale.<br>
                            <strong>Processo:</strong>
                            <ol style="margin-top: 10px;">
                                <li>Raccoglie dati (cliente, timesheet IDs, causale)</li>
                                <li>Chiama API <code>generateProforma()</code></li>
                                <li>Backend genera PDF</li>
                                <li>Backend invia email</li>
                                <li>Frontend mostra link PDF e conferma</li>
                            </ol>
                        </div>
                        <div class="correlation">
                            <div class="correlation-title">üîó Chiama API:</div>
                            <code>GET ?action=generate_proforma</code> ‚Üí Backend <code>generateAndSendProforma()</code>
                        </div>
                    </div>
                </div>

                <!-- api.js -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ api.js - Chiamate Backend</h3>

                    <div class="info-box">
                        <strong>üì° Tutte le chiamate API usano fetch() con:</strong>
                        <ul style="margin-top: 10px;">
                            <li>URL: <code>CONFIG.APPS_SCRIPT_URL</code></li>
                            <li>Method: GET (Apps Script non supporta POST fetch diretto)</li>
                            <li>Parametri: Query string</li>
                            <li>Response: JSON</li>
                        </ul>
                    </div>

                    <div class="function-card">
                        <div class="function-name">getClientsAndConfig()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <div class="function-desc">
                            <strong>Endpoint:</strong> <code>?action=get_data</code><br>
                            <strong>Return:</strong> <code>{ clients: [...], config: {...} }</code>
                        </div>
                    </div>

                    <div class="function-card">
                        <div class="function-name">getLastWarning()</div>
                        <span class="badge badge-frontend">Frontend</span>
                        <div class="function-desc">
                            <strong>Endpoint:</strong> <code>?action=get_last_warning</code><br>
                            <strong>Scopo:</strong> Recupera warning pacchetti dopo submit timesheet
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- 5. FLUSSI DATI COMPLETI -->
            <!-- ============================================ -->
            <div class="section" id="flows">
                <h2 class="section-title">üîÑ 5. Flussi Dati Completi</h2>

                <!-- Flusso Inserimento Timesheet -->
                <div class="subsection">
                    <h3 class="subsection-title">‚è±Ô∏è Flusso 1: Inserimento Timesheet</h3>

                    <div class="flow-diagram">
<span class="flow-step">1. FRONTEND - Caricamento Iniziale</span>
   ‚îú‚îÄ main.js: DOMContentLoaded
   ‚îú‚îÄ timesheet.js: initTimesheet()
   ‚îú‚îÄ api.js: getClientsAndConfig()
   ‚îî‚îÄ Backend: doGet(?action=get_data)
       ‚îî‚îÄ DataService: getClientsList() + getConfigOptions()
       ‚îî‚îÄ Return: { clients: [...], config: {...} }

<span class="flow-step">2. FRONTEND - Popolamento Form</span>
   ‚îú‚îÄ timesheet.js: populateFormFields()
   ‚îú‚îÄ window.clients = [...] (CACHE)
   ‚îú‚îÄ Datalist clienti popolato
   ‚îú‚îÄ Select configurazioni popolate
   ‚îî‚îÄ setupClientValidation() ‚≠ê ATTIVATA

<span class="flow-step">3. UTENTE - Compila Form</span>
   ‚îú‚îÄ Digita nome cliente
   ‚îú‚îÄ setupClientValidation() ‚Üí Bordo verde/rosso real-time ‚≠ê
   ‚îú‚îÄ Compila altri campi
   ‚îî‚îÄ Click "Salva Timesheet"

<span class="flow-step">4. FRONTEND - Validazione Pre-Submit</span>
   ‚îú‚îÄ handleFormSubmit(event)
   ‚îú‚îÄ üö® Verifica cliente in window.clients ‚≠ê
   ‚îú‚îÄ Se NON valido:
   ‚îÇ   ‚îú‚îÄ event.preventDefault()
   ‚îÇ   ‚îú‚îÄ Messaggio errore critico
   ‚îÇ   ‚îî‚îÄ STOP (non invia)
   ‚îî‚îÄ Se valido: Procede con submit

<span class="flow-step">5. FRONTEND - Submit Form</span>
   ‚îú‚îÄ Form POST ‚Üí iframe hidden
   ‚îî‚îÄ Target: APPS_SCRIPT_URL (WEB_APP_EXEC_URL)

<span class="flow-step">6. BACKEND - Riceve POST</span>
   ‚îú‚îÄ doPost(e)
   ‚îú‚îÄ const data = e.parameter
   ‚îî‚îÄ üö® validateClient(data.client) ‚≠ê NUOVA VALIDAZIONE

<span class="flow-step">7. BACKEND - Validazione Cliente</span>
   ‚îú‚îÄ validateClient(clientName)
   ‚îú‚îÄ Legge foglio Clienti (colonna B)
   ‚îú‚îÄ Cerca match esatto (case-sensitive)
   ‚îú‚îÄ Se NON trovato:
   ‚îÇ   ‚îú‚îÄ writeLog('ERROR', 'VALIDATE_CLIENT', ...)
   ‚îÇ   ‚îú‚îÄ Return { valid: false, error: "..." }
   ‚îÇ   ‚îî‚îÄ doPost: BLOCCA inserimento + Return error
   ‚îî‚îÄ Se trovato:
       ‚îú‚îÄ writeLog('INFO', 'VALIDATE_CLIENT', ...)
       ‚îú‚îÄ Return { valid: true, clientId: "C_XXX" }
       ‚îî‚îÄ doPost: Procede con clientID validato

<span class="flow-step">8. BACKEND - Generazione ID Intervento</span>
   ‚îú‚îÄ generateInterventoID(sheet)
   ‚îú‚îÄ Legge tutti ID esistenti
   ‚îú‚îÄ Trova massimo dell'anno corrente
   ‚îî‚îÄ Return: "I_2025_042"

<span class="flow-step">9. BACKEND - Gestione Pacchetti (opzionale)</span>
   ‚îú‚îÄ Se mod_addebito === "Scala da pacchetto":
   ‚îÇ   ‚îú‚îÄ getActivePacchetto(clientID)
   ‚îÇ   ‚îú‚îÄ Se pacchetto trovato:
   ‚îÇ   ‚îÇ   ‚îú‚îÄ updatePacchetto(pacchetto, oreUtilizzate)
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Scala ore
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Aggiorna stato (ATTIVO/TERMINATO/OVER)
   ‚îÇ   ‚îÇ   ‚îú‚îÄ Genera alert se necessario
   ‚îÇ   ‚îÇ   ‚îî‚îÄ Cambia mod_addebito in "Scalato" o "Ore superate"
   ‚îÇ   ‚îî‚îÄ Se NON trovato:
   ‚îÇ       ‚îî‚îÄ warning = "Nessun pacchetto attivo"

<span class="flow-step">10. BACKEND - Salvataggio Timesheet</span>
   ‚îú‚îÄ Prepara newRow = [ID_Intervento, clientID, ...]
   ‚îú‚îÄ sheet.appendRow(newRow)
   ‚îú‚îÄ Formatta cella durata (colonna I)
   ‚îî‚îÄ writeLog('SUCCESS', 'INSERT_TIMESHEET', ...)

<span class="flow-step">11. BACKEND - Email Cliente (opzionale)</span>
   ‚îú‚îÄ Se send_email === true:
   ‚îÇ   ‚îú‚îÄ sendEmailToClient(data, clientEmail)
   ‚îÇ   ‚îî‚îÄ Invia riepilogo timesheet

<span class="flow-step">12. BACKEND - Salvataggio Warning</span>
   ‚îú‚îÄ Se warningMessage esistente:
   ‚îÇ   ‚îú‚îÄ PropertiesService.setProperty('LAST_WARNING', ...)
   ‚îÇ   ‚îî‚îÄ Timestamp salvato

<span class="flow-step">13. BACKEND - Response</span>
   ‚îî‚îÄ Return HtmlService: "Success|||WARNING|||messaggio"

<span class="flow-step">14. FRONTEND - Gestione Response</span>
   ‚îú‚îÄ iframe.onload
   ‚îú‚îÄ Attesa 1 secondo (backend completa scrittura)
   ‚îú‚îÄ getLastWarning() ‚Üí Recupera warning pacchetti
   ‚îú‚îÄ Se warning presente:
   ‚îÇ   ‚îú‚îÄ Determina tipo (TERMINATO/OVER/SCADUTO)
   ‚îÇ   ‚îú‚îÄ Mostra alert colorato con dettagli
   ‚îÇ   ‚îî‚îÄ Auto-hide dopo N secondi
   ‚îú‚îÄ Mostra "‚úÖ Timesheet salvato"
   ‚îú‚îÄ Reset form (mantiene data)
   ‚îî‚îÄ Pronto per nuovo inserimento
                    </div>
                </div>

                <!-- Flusso Generazione Proforma -->
                <div class="subsection">
                    <h3 class="subsection-title">üìÑ Flusso 2: Generazione Proforma</h3>

                    <div class="flow-diagram">
<span class="flow-step">1. FRONTEND - Step 1: Selezione Cliente</span>
   ‚îú‚îÄ proforma.js: Utente seleziona cliente
   ‚îî‚îÄ Click "Avanti"

<span class="flow-step">2. FRONTEND - Step 2: Carica Timesheet</span>
   ‚îú‚îÄ loadTimesheetForClient()
   ‚îú‚îÄ api.js: getTimesheetDaFatturare(clientName)
   ‚îî‚îÄ Backend: doGet(?action=get_timesheet_da_fatturare)
       ‚îî‚îÄ DataService: getTimesheetDaFatturare()
           ‚îú‚îÄ Filtra: Nome_Cliente = X
           ‚îú‚îÄ Filtra: Mod_Addebito = "Da fatturare"
           ‚îî‚îÄ Return: array timesheet

<span class="flow-step">3. FRONTEND - Step 2: Selezione Timesheet</span>
   ‚îú‚îÄ displayTimesheetTable(timesheet)
   ‚îú‚îÄ Mostra tabella con checkbox
   ‚îú‚îÄ Utente seleziona righe da fatturare
   ‚îî‚îÄ Click "Avanti"

<span class="flow-step">4. FRONTEND - Step 3: Riepilogo</span>
   ‚îú‚îÄ proceedToStep3()
   ‚îú‚îÄ Calcola periodo (prima data - ultima data)
   ‚îú‚îÄ Suggerisce causale
   ‚îú‚îÄ Calcola totali (ore, costi)
   ‚îú‚îÄ Utente conferma causale e quota ritenuta
   ‚îî‚îÄ Click "Genera e Invia Proforma"

<span class="flow-step">5. FRONTEND - Chiamata API</span>
   ‚îú‚îÄ generateProformaFinal()
   ‚îú‚îÄ api.js: generateProforma(clientName, timesheetIds, causale, applicaQuota)
   ‚îî‚îÄ Parametri: ?action=generate_proforma&client_name=...&timesheet_ids=1,2,3&...

<span class="flow-step">6. BACKEND - Riceve Richiesta</span>
   ‚îú‚îÄ doGet(?action=generate_proforma)
   ‚îú‚îÄ Estrae parametri
   ‚îú‚îÄ getClientData(clientName) ‚Üí Dati completi cliente
   ‚îú‚îÄ getTimesheetByIds(timesheetIds) ‚Üí Recupera timesheet selezionati
   ‚îî‚îÄ generateAndSendProforma(clientData, timesheet, causale, applicaQuota)

<span class="flow-step">7. BACKEND - Generazione Documento</span>
   ‚îú‚îÄ ProformaService: createProformaDocument()
   ‚îú‚îÄ Copia template da Drive
   ‚îú‚îÄ Popola segnaposto:
   ‚îÇ   ‚îú‚îÄ {{NUMERO_PROFORMA}}
   ‚îÇ   ‚îú‚îÄ {{DATA}}
   ‚îÇ   ‚îú‚îÄ {{CLIENTE_NOME}}, {{CLIENTE_INDIRIZZO}}, ecc.
   ‚îÇ   ‚îú‚îÄ {{CAUSALE}}
   ‚îÇ   ‚îî‚îÄ Tabella timesheet
   ‚îú‚îÄ Calcola totali:
   ‚îÇ   ‚îú‚îÄ Imponibile
   ‚îÇ   ‚îú‚îÄ IVA 22%
   ‚îÇ   ‚îú‚îÄ Ritenuta 20% (opzionale)
   ‚îÇ   ‚îî‚îÄ Totale
   ‚îî‚îÄ Salva documento temporaneo

<span class="flow-step">8. BACKEND - Numero Proforma</span>
   ‚îú‚îÄ getNextProformaNumber()
   ‚îú‚îÄ Legge ultimo numero da Config sheet
   ‚îú‚îÄ Incrementa di 1
   ‚îú‚îÄ Aggiorna Config sheet
   ‚îî‚îÄ Return: "PRF_2025_042"

<span class="flow-step">9. BACKEND - Conversione PDF</span>
   ‚îú‚îÄ convertPdfAndSave(docId)
   ‚îú‚îÄ Drive API: export as PDF
   ‚îú‚îÄ Salva in cartella "PROFORMA" su Drive
   ‚îî‚îÄ Return: PDF File object + URL

<span class="flow-step">10. BACKEND - Invio Email</span>
   ‚îú‚îÄ sendProformaEmail(clientData, pdfFile)
   ‚îú‚îÄ Destinatario: email cliente
   ‚îú‚îÄ Oggetto: "Proforma PRF_2025_042"
   ‚îú‚îÄ Corpo: Messaggio con dettagli
   ‚îî‚îÄ Allegato: PDF proforma

<span class="flow-step">11. BACKEND - Aggiornamento Timesheet</span>
   ‚îú‚îÄ Per ogni timesheet ID:
   ‚îÇ   ‚îú‚îÄ Trova riga nel foglio Timesheet
   ‚îÇ   ‚îú‚îÄ Cambia Mod_Addebito da "Da fatturare" a "Fatturato"
   ‚îÇ   ‚îî‚îÄ Inserisci numero proforma in colonna M
   ‚îî‚îÄ writeLog('SUCCESS', 'GENERATE_PROFORMA', ...)

<span class="flow-step">12. BACKEND - Response</span>
   ‚îî‚îÄ Return JSON: {
       success: true,
       pdfUrl: "https://drive.google.com/...",
       proformaNumber: "PRF_2025_042"
     }

<span class="flow-step">13. FRONTEND - Mostra Successo</span>
   ‚îú‚îÄ Riceve response
   ‚îú‚îÄ Mostra messaggio: "‚úÖ Proforma generata e inviata"
   ‚îú‚îÄ Link al PDF su Drive
   ‚îú‚îÄ Numero proforma
   ‚îî‚îÄ Reset form per nuova proforma
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- 6. API ENDPOINTS -->
            <!-- ============================================ -->
            <div class="section" id="api">
                <h2 class="section-title">üì° 6. API Endpoints</h2>

                <div class="subsection">
                    <h3 class="subsection-title">Tutti gli Endpoint Disponibili</h3>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=get_data
<strong>Scopo:</strong> Carica clienti e configurazioni iniziali
<strong>Return:</strong> { clients: [...], config: {...} }
<strong>Usato da:</strong> timesheet.js (loadFormData)
                    </div>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=add_client&client_name=...&client_email=...
<strong>Scopo:</strong> Aggiunge nuovo cliente
<strong>Return:</strong> { success: true, message: "..." }
<strong>Usato da:</strong> timesheet.js (saveNewClient)
                    </div>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=get_timesheet_da_fatturare&client_name=...
<strong>Scopo:</strong> Recupera timesheet da proformare per cliente
<strong>Return:</strong> { success: true, timesheet: [...] }
<strong>Usato da:</strong> proforma.js (loadTimesheetForClient)
                    </div>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=generate_proforma&client_name=...&timesheet_ids=...&causale=...&applica_quota=...
<strong>Scopo:</strong> Genera PDF proforma e invia email
<strong>Return:</strong> { success: true, pdfUrl: "...", proformaNumber: "..." }
<strong>Usato da:</strong> proforma.js (generateProformaFinal)
                    </div>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=get_last_warning
<strong>Scopo:</strong> Recupera ultimo warning pacchetti
<strong>Return:</strong> { success: true, warning: "..." }
<strong>Usato da:</strong> timesheet.js (handleFormSubmit - dopo save)
                    </div>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=get_logs&limit=100
<strong>Scopo:</strong> Recupera log di sistema
<strong>Return:</strong> { success: true, logs: [...] }
<strong>Usato da:</strong> utilities.js (tab Utilities)
                    </div>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=clean_logs&days=30
<strong>Scopo:</strong> Pulisce log pi√π vecchi di N giorni
<strong>Return:</strong> { success: true, deleted: N }
<strong>Usato da:</strong> utilities.js (tab Utilities)
                    </div>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=backup
<strong>Scopo:</strong> Genera backup metadata
<strong>Return:</strong> { success: true, backup: {...} }
<strong>Usato da:</strong> utilities.js (tab Utilities)
                    </div>

                    <div class="api-endpoint">
<strong>GET</strong> ?action=test_connection
<strong>Scopo:</strong> Test connessione backend
<strong>Return:</strong> { success: true, message: "...", sheets: N }
<strong>Usato da:</strong> utilities.js (tab Utilities)
                    </div>

                    <div class="api-endpoint">
<strong>POST</strong> (form submit via iframe)
<strong>Scopo:</strong> Inserimento nuovo timesheet
<strong>Parametri:</strong> client, date, duration, tipo_intervento, ecc.
<strong>Return:</strong> HtmlService "Success|||WARNING|||..."
<strong>Usato da:</strong> Form timesheet (submit diretto)
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- 7. CORRELAZIONI -->
            <!-- ============================================ -->
            <div class="section" id="correlations">
                <h2 class="section-title">üîó 7. Correlazioni tra File</h2>

                <div class="subsection">
                    <h3 class="subsection-title">Mappa delle Dipendenze</h3>

                    <table>
                        <thead>
                            <tr>
                                <th>File Frontend</th>
                                <th>Chiama API</th>
                                <th>Backend Endpoint</th>
                                <th>Backend File</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>timesheet.js</strong></td>
                                <td>getClientsAndConfig()</td>
                                <td>?action=get_data</td>
                                <td>Code.gs (doGet) ‚Üí DataService.gs</td>
                            </tr>
                            <tr>
                                <td><strong>timesheet.js</strong></td>
                                <td>addClient()</td>
                                <td>?action=add_client</td>
                                <td>Code.gs (doGet)</td>
                            </tr>
                            <tr>
                                <td><strong>timesheet.js</strong></td>
                                <td>Form submit (POST)</td>
                                <td>Direct POST</td>
                                <td>Code.gs (doPost) ‚Üí validateClient() ‚≠ê</td>
                            </tr>
                            <tr>
                                <td><strong>proforma.js</strong></td>
                                <td>getTimesheetDaFatturare()</td>
                                <td>?action=get_timesheet_da_fatturare</td>
                                <td>Code.gs (doGet) ‚Üí DataService.gs</td>
                            </tr>
                            <tr>
                                <td><strong>proforma.js</strong></td>
                                <td>generateProforma()</td>
                                <td>?action=generate_proforma</td>
                                <td>Code.gs (doGet) ‚Üí ProformaService.gs</td>
                            </tr>
                            <tr>
                                <td><strong>utilities.js</strong></td>
                                <td>getLogs()</td>
                                <td>?action=get_logs</td>
                                <td>Code.gs (doGet) ‚Üí Utilities.gs</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">Catena di Chiamate Critiche</h3>

                    <div class="success-box">
                        <strong>üéØ Inserimento Timesheet (con validazione):</strong><br><br>
                        <code>timesheet.js: handleFormSubmit()</code><br>
                        ‚îî‚îÄ ‚≠ê Valida cliente in <code>window.clients</code><br>
                        ‚îî‚îÄ Se OK: Submit form via iframe<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ <code>Code.gs: doPost()</code><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ ‚≠ê <code>validateClient(clientName)</code><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ Se NON valido: BLOCCA + writeLog(ERROR)<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ Se valido: Return clientID<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ <code>generateInterventoID()</code><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ Se "Scala da pacchetto":<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ <code>PacchettiService: getActivePacchetto()</code><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ <code>PacchettiService: updatePacchetto()</code><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ Salva timesheet<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ <code>EmailService: sendEmailToClient()</code><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ <code>Utilities: writeLog(SUCCESS)</code><br>
                        ‚îî‚îÄ Frontend: <code>getLastWarning()</code><br>
                        ‚îî‚îÄ Mostra successo + warning pacchetti
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- 8. FUNZIONI CRITICHE -->
            <!-- ============================================ -->
            <div class="section" id="critical">
                <h2 class="section-title">üö® 8. Funzioni Critiche per Integrit√† Dati</h2>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è ATTENZIONE:</strong> Queste funzioni sono CRITICHE per l'integrit√† dei dati. Modificarle richiede massima attenzione e testing approfondito.
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">Backend - Funzioni Critiche</h3>

                    <table>
                        <thead>
                            <tr>
                                <th>Funzione</th>
                                <th>File</th>
                                <th>Criticit√†</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #f8d7da;">
                                <td><code>validateClient()</code> ‚≠ê</td>
                                <td>Code.gs</td>
                                <td>üö® MASSIMA</td>
                                <td>Impedisce inserimenti con clienti non validi. Se fallisce, dati corrotti.</td>
                            </tr>
                            <tr style="background: #f8d7da;">
                                <td><code>doPost()</code></td>
                                <td>Code.gs</td>
                                <td>üö® MASSIMA</td>
                                <td>Gestisce TUTTI gli inserimenti timesheet. Errori = perdita dati.</td>
                            </tr>
                            <tr style="background: #fff3cd;">
                                <td><code>generateInterventoID()</code></td>
                                <td>Code.gs</td>
                                <td>‚ö†Ô∏è ALTA</td>
                                <td>Genera ID univoci. Duplicati o errori causano conflitti.</td>
                            </tr>
                            <tr style="background: #fff3cd;">
                                <td><code>updatePacchetto()</code></td>
                                <td>PacchettiService.gs</td>
                                <td>‚ö†Ô∏è ALTA</td>
                                <td>Scala ore da pacchetti. Errori = contabilit√† errata.</td>
                            </tr>
                            <tr style="background: #fff3cd;">
                                <td><code>generateAndSendProforma()</code></td>
                                <td>ProformaService.gs</td>
                                <td>‚ö†Ô∏è ALTA</td>
                                <td>Genera fatture. Errori = documenti fiscali errati.</td>
                            </tr>
                            <tr>
                                <td><code>writeLog()</code></td>
                                <td>Utilities.gs</td>
                                <td>üìä MEDIA</td>
                                <td>Tracciabilit√†. Se fallisce, perdi visibilit√† sugli errori.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">Frontend - Funzioni Critiche</h3>

                    <table>
                        <thead>
                            <tr>
                                <th>Funzione</th>
                                <th>File</th>
                                <th>Criticit√†</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #f8d7da;">
                                <td><code>handleFormSubmit()</code> ‚≠ê</td>
                                <td>timesheet.js</td>
                                <td>üö® MASSIMA</td>
                                <td>Validazione frontend. Prima linea di difesa contro dati invalidi.</td>
                            </tr>
                            <tr style="background: #fff3cd;">
                                <td><code>setupClientValidation()</code> ‚≠ê</td>
                                <td>timesheet.js</td>
                                <td>‚ö†Ô∏è ALTA</td>
                                <td>Feedback real-time. Previene errori utente.</td>
                            </tr>
                            <tr style="background: #fff3cd;">
                                <td><code>loadFormData()</code></td>
                                <td>timesheet.js</td>
                                <td>‚ö†Ô∏è ALTA</td>
                                <td>Carica dati essenziali. Se fallisce, app non funziona.</td>
                            </tr>
                            <tr>
                                <td><code>generateProformaFinal()</code></td>
                                <td>proforma.js</td>
                                <td>üìä MEDIA</td>
                                <td>Genera proforma. Errori visibili all'utente.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">‚ö†Ô∏è Regole d'Oro per Modifiche</h3>

                    <ol style="line-height: 2; margin-top: 15px;">
                        <li><strong>SEMPRE fare backup</strong> prima di modificare funzioni critiche</li>
                        <li><strong>Non rimuovere</strong> <code>validateClient()</code> da <code>doPost()</code></li>
                        <li><strong>Non rimuovere</strong> validazione da <code>handleFormSubmit()</code></li>
                        <li><strong>Testare su dati di test</strong> prima di usare in produzione</li>
                        <li><strong>Controllare i log</strong> dopo ogni modifica critica</li>
                        <li><strong>Non modificare mai</strong> la struttura base dei fogli Google</li>
                        <li><strong>Mantenere</strong> <code>writeLog()</code> in tutte le funzioni critiche</li>
                    </ol>
                </div>
            </div>

        </div>

        <div style="background: #f8f9fa; padding: 40px; text-align: center; border-top: 2px solid #e9ecef;">
            <p><strong>CRM Studio Smart</strong> - Documentazione Tecnica Dettagliata</p>
            <p>Versione 2.0 - Aggiornato: 23 Ottobre 2025</p>
            <p style="margin-top: 20px;">
                <a href="#overview" style="margin: 0 10px;">üìö Torna all'inizio</a> |
                <a href="https://github.com/niubbone/TSFE" target="_blank" style="margin: 0 10px;">üì¶ GitHub</a> |
                <a href="mailto:info@studio-smart.it" style="margin: 0 10px;">üìß Supporto</a>
            </p>
        </div>
    </div>
</body>
</html>
