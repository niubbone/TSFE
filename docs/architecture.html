<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Studio Smart - Riepilogo Completo v3.7</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .subsection {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .subsection-title {
            font-size: 1.3rem;
            color: #764ba2;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .card-content {
            color: #666;
            font-size: 0.95rem;
        }
        
        .file-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .file-item {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 5px 0;
            color: #e74c3c;
        }
        
        .stats-box {
            display: inline-block;
            background: #e3f2fd;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 10px 10px 10px 0;
            border-left: 4px solid #2196f3;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1976d2;
        }
        
        .stats-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }
        
        .badge-success { background: #d4edda; color: #155724; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-primary { background: #cfe2ff; color: #084298; }
        
        .info-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e74c3c;
            font-size: 0.9em;
        }
        
        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .toc ul {
            list-style: none;
            padding-left: 0;
        }
        
        .toc li {
            padding: 8px 0;
        }
        
        .toc a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üöÄ CRM STUDIO SMART</h1>
            <p>Documentazione Tecnica Completa</p>
            <div class="version-badge">Versione 3.7 - 31 Ottobre 2025</div>
        </div>

        <div class="content">
            <!-- TOC -->
            <div class="toc">
                <h3 style="margin-bottom: 15px;">üìë Indice</h3>
                <ul>
                    <li><a href="#executive">1. Executive Summary</a></li>
                    <li><a href="#architecture">2. Architettura Sistema</a></li>
                    <li><a href="#backend">3. Backend (Apps Script)</a></li>
                    <li><a href="#frontend">4. Frontend (JavaScript)</a></li>
                    <li><a href="#database">5. Struttura Database (Google Sheet)</a></li>
                    <li><a href="#flows">6. Flussi Operativi Principali</a></li>
                    <li><a href="#api">7. API Endpoints</a></li>
                    <li><a href="#changelog">8. Changelog v3.0 ‚Üí v3.7</a></li>
                    <li><a href="#quickref">9. Quick Reference</a></li>
                </ul>
            </div>

            <!-- EXECUTIVE SUMMARY -->
            <div class="section" id="executive">
                <h2 class="section-title">üìã 1. Executive Summary</h2>
                
                <div class="success-box">
                    <h3 style="margin-bottom: 10px;">‚úÖ Stato Attuale: v3.7 Operativa</h3>
                    <p>Sistema CRM completo per gestione clienti, timesheet, vendite (Canoni, Firme, Pacchetti), proforma, rinnovi automatici e scadenzario integrato con Google Calendar.</p>
                </div>

                <div class="grid">
                    <div class="stats-box">
                        <div class="stats-number">~9.500</div>
                        <div class="stats-label">Righe di Codice</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-number">15</div>
                        <div class="stats-label">File Backend (.gs)</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-number">9</div>
                        <div class="stats-label">File Frontend (.js)</div>
                    </div>
                    <div class="stats-box">
                        <div class="stats-number">50+</div>
                        <div class="stats-label">API Endpoints</div>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üéØ Funzionalit√† Principali</h3>
                    <ul style="margin-left: 20px;">
                        <li>‚úÖ Gestione Clienti (CRUD completo)</li>
                        <li>‚úÖ Timesheet con tracciamento ore e modalit√† addebito</li>
                        <li>‚úÖ Pacchetti ore con gestione automatica residui</li>
                        <li>‚úÖ Proforma automatiche con template Google Docs</li>
                        <li>‚úÖ Vendite: Canoni, Firme Digitali, Pacchetti</li>
                        <li>‚úÖ Google Calendar integrato per scadenze</li>
                        <li>‚úÖ Sistema rinnovi automatici con storico</li>
                        <li>‚úÖ Email automatiche per scadenze (30gg, 10gg)</li>
                        <li>‚úÖ Sistema log completo</li>
                        <li>‚úÖ PWA mobile-first</li>
                    </ul>
                </div>
            </div>

            <!-- ARCHITETTURA -->
            <div class="section" id="architecture">
                <h2 class="section-title">üèóÔ∏è 2. Architettura Sistema</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">Stack Tecnologico</h3>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Layer</th>
                                <th>Tecnologia</th>
                                <th>Descrizione</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Frontend</strong></td>
                                <td>HTML5 + Vanilla JS + CSS3</td>
                                <td>SPA mobile-first, PWA con manifest</td>
                            </tr>
                            <tr>
                                <td><strong>Backend</strong></td>
                                <td>Google Apps Script</td>
                                <td>Serverless, deployed come Web App</td>
                            </tr>
                            <tr>
                                <td><strong>Database</strong></td>
                                <td>Google Sheets</td>
                                <td>Multi-tab, formule automatiche</td>
                            </tr>
                            <tr>
                                <td><strong>Calendar</strong></td>
                                <td>Google Calendar API</td>
                                <td>Eventi scadenze con alert programmati</td>
                            </tr>
                            <tr>
                                <td><strong>Email</strong></td>
                                <td>Gmail API (MailApp/GmailApp)</td>
                                <td>Invio proforma e alert automatici</td>
                            </tr>
                            <tr>
                                <td><strong>Storage</strong></td>
                                <td>Google Drive</td>
                                <td>PDF proforma e template</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">Flusso Dati</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #667eea; font-family: monospace; white-space: pre; overflow-x: auto;">
Browser (index.html)
    ‚Üì AJAX
Frontend JS (api.js)
    ‚Üì POST/GET
Apps Script Web App (doGet/doPost)
    ‚Üì Router
Backend Functions (.gs files)
    ‚Üì Read/Write
Google Sheets (Database)
    ‚Üì Triggers
Calendar API / Email API
                    </div>
                </div>

                <div class="info-box">
                    <h4 style="margin-bottom: 10px;">üîó URL Principali</h4>
                    <p><strong>Apps Script Deployment:</strong><br>
                    <code>https://script.google.com/macros/s/AKfycbxrpkmfBlraaYihYYtJB0uvg8K60sPM-9uLmybcqoiVM6rSabZe6QK_-00L9CGAFwdo/exec</code></p>
                    <p style="margin-top: 10px;"><strong>Google Sheet ID:</strong><br>
                    <code>1aSNuc5fzkgUERsJ6pNPn-Rkte3SJMcksHNicCu8T2yQ</code></p>
                    <p style="margin-top: 10px;"><strong>Calendar ID:</strong><br>
                    <code>c_602ffac63141bc23636d5769b78bf0d34fdaf50fd74dc779abc5df0eac54f77f@group.calendar.google.com</code></p>
                </div>
            </div>

            <!-- BACKEND -->
            <div class="section" id="backend">
                <h2 class="section-title">‚öôÔ∏è 3. Backend (Apps Script)</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">Struttura File Backend (15 file .gs)</h3>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Righe</th>
                                <th>Responsabilit√†</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>Codice.gs</code></td>
                                <td>1.363</td>
                                <td><strong>ROUTER PRINCIPALE</strong> - doGet/doPost, validazione cliente, routing API</td>
                            </tr>
                            <tr>
                                <td><code>Clienti.gs</code></td>
                                <td>848</td>
                                <td>CRUD clienti, getClientsList, ricerca, validazione</td>
                            </tr>
                            <tr>
                                <td><code>Utilities.gs</code></td>
                                <td>640</td>
                                <td>Log system, check integrity, backup, clean logs</td>
                            </tr>
                            <tr>
                                <td><code>EmailScadenze.gs</code></td>
                                <td>578</td>
                                <td>Template email scadenze (30gg, 10gg), pacchetti OVER/TERMINATO</td>
                            </tr>
                            <tr>
                                <td><code>Email.gs</code></td>
                                <td>574</td>
                                <td>Invio email proforma, gestione allegati PDF</td>
                            </tr>
                            <tr>
                                <td><code>Pacchetti.gs</code></td>
                                <td>394</td>
                                <td>CRUD pacchetti, getActivePacchetto, updatePacchetto, getPacchettiScaduti</td>
                            </tr>
                            <tr>
                                <td><code>Firme.gs</code></td>
                                <td>350</td>
                                <td>CRUD firme digitali, getFirmeInScadenza, generateFirmaID</td>
                            </tr>
                            <tr>
                                <td><code>Trigger.gs</code></td>
                                <td>329</td>
                                <td>Trigger giornaliero (8:00), checkScadenzeGiornaliero, checkFirmeScadenze</td>
                            </tr>
                            <tr>
                                <td><code>Canoni.gs</code></td>
                                <td>325</td>
                                <td>CRUD canoni, getCanoniInScadenza, generateCanoneID</td>
                            </tr>
                            <tr>
                                <td><code>Rinnovi.gs</code></td>
                                <td>291</td>
                                <td>rinnovaCanone, rinnovaFirma, getStoricoRinnovi, canRinnovaProdotto</td>
                            </tr>
                            <tr>
                                <td><code>Proforma.gs</code></td>
                                <td>265</td>
                                <td>generateProforma, createProformaPDF, template processing</td>
                            </tr>
                            <tr>
                                <td><code>Calendar.gs</code></td>
                                <td>203</td>
                                <td>createScadenzaEvent, deleteCalendarEvent, updateCalendarEvent</td>
                            </tr>
                            <tr>
                                <td><code>Timesheet.gs</code></td>
                                <td>160</td>
                                <td>getTimesheetDaFatturare, updateTimesheetProforma</td>
                            </tr>
                            <tr>
                                <td><code>Helpers.gs</code></td>
                                <td>101</td>
                                <td>getSpreadsheet, getConfigOptions, convertDurationToHours</td>
                            </tr>
                            <tr>
                                <td><code>Config.gs</code></td>
                                <td>19</td>
                                <td>Costanti di configurazione (URL, IDs, nomi fogli)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üîë Funzioni Backend Chiave</h3>
                    
                    <div class="grid">
                        <div class="card">
                            <div class="card-title">üìù Timesheet & Pacchetti</div>
                            <div class="card-content">
                                ‚Ä¢ insertTimesheet()<br>
                                ‚Ä¢ getActivePacchetto()<br>
                                ‚Ä¢ updatePacchetto()<br>
                                ‚Ä¢ getPacchettiScaduti()
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">üí∞ Vendite</div>
                            <div class="card-content">
                                ‚Ä¢ insertCanone()<br>
                                ‚Ä¢ insertFirma()<br>
                                ‚Ä¢ insertPacchetto()<br>
                                ‚Ä¢ generateCanoneID()
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">üîÑ Rinnovi</div>
                            <div class="card-content">
                                ‚Ä¢ rinnovaCanone()<br>
                                ‚Ä¢ rinnovaFirma()<br>
                                ‚Ä¢ getStoricoRinnovi()<br>
                                ‚Ä¢ canRinnovaProdotto()
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">üìÖ Scadenze</div>
                            <div class="card-content">
                                ‚Ä¢ getCanoniInScadenza()<br>
                                ‚Ä¢ getFirmeInScadenza()<br>
                                ‚Ä¢ getTuttiProdottiInScadenza()<br>
                                ‚Ä¢ createScadenzaEvent()
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">üìß Email</div>
                            <div class="card-content">
                                ‚Ä¢ sendProformaEmail()<br>
                                ‚Ä¢ sendFirmaReminderCliente30gg()<br>
                                ‚Ä¢ sendFirmaReminderGiuseppe10gg()<br>
                                ‚Ä¢ sendPacchettoScadutoAlert()
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">üë• Clienti</div>
                            <div class="card-content">
                                ‚Ä¢ getClientsList()<br>
                                ‚Ä¢ validateClient()<br>
                                ‚Ä¢ insertClient()<br>
                                ‚Ä¢ updateClient()
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FRONTEND -->
            <div class="section" id="frontend">
                <h2 class="section-title">üíª 4. Frontend (JavaScript)</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">Struttura File Frontend (9 file .js + 9 file .css)</h3>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>File JS</th>
                                <th>Righe</th>
                                <th>Responsabilit√†</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>utilities.js</code></td>
                                <td>747</td>
                                <td>Funzioni utility globali, helpers UI, date formatting</td>
                            </tr>
                            <tr>
                                <td><code>clienti.js</code></td>
                                <td>726</td>
                                <td>UI gestione clienti, tab clienti, form CRUD</td>
                            </tr>
                            <tr>
                                <td><code>vendite.js</code></td>
                                <td>542</td>
                                <td>Form vendite (Canoni, Firme, Pacchetti), validazione</td>
                            </tr>
                            <tr>
                                <td><code>timesheet.js</code></td>
                                <td>393</td>
                                <td>Form timesheet, gestione pacchetti attivi</td>
                            </tr>
                            <tr>
                                <td><code>proforma.js</code></td>
                                <td>264</td>
                                <td>Generazione proforma, selezione timesheet, email</td>
                            </tr>
                            <tr>
                                <td><code>main.js</code></td>
                                <td>153</td>
                                <td>Init app, routing tab, load initial data</td>
                            </tr>
                            <tr>
                                <td><code>api.js</code></td>
                                <td>113</td>
                                <td>Wrapper chiamate API backend, error handling</td>
                            </tr>
                            <tr>
                                <td><code>utils.js</code></td>
                                <td>82</td>
                                <td>Funzioni utility aggiuntive</td>
                            </tr>
                            <tr>
                                <td><code>config.js</code></td>
                                <td>21</td>
                                <td>Costanti frontend (Apps Script URL)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üé® File CSS (9 file modulari)</h3>
                    <div class="file-list">
                        <div class="file-item">‚Ä¢ main.css - Layout principale, variabili</div>
                        <div class="file-item">‚Ä¢ clienti.css - Stili tab clienti</div>
                        <div class="file-item">‚Ä¢ forms.css - Form styling globale</div>
                        <div class="file-item">‚Ä¢ tables.css - Tabelle responsive</div>
                        <div class="file-item">‚Ä¢ tabs.css - Sistema tab navigation</div>
                        <div class="file-item">‚Ä¢ modals.css - Modale popup</div>
                        <div class="file-item">‚Ä¢ utilities.css - Utility classes</div>
                        <div class="file-item">‚Ä¢ vendite.css - UI vendite</div>
                        <div class="file-item">‚Ä¢ vendite-scaduti.css - Sezione scaduti</div>
                    </div>
                </div>

                <div class="info-box">
                    <h4 style="margin-bottom: 10px;">üì± PWA Features</h4>
                    <ul style="margin-left: 20px;">
                        <li>‚úÖ <code>manifest.json</code> configurato</li>
                        <li>‚úÖ Icone multiple risoluzioni (192x192, 512x512)</li>
                        <li>‚úÖ Mobile-first design</li>
                        <li>‚úÖ Installabile su home screen</li>
                        <li>‚úÖ Responsive layout</li>
                    </ul>
                </div>
            </div>

            <!-- DATABASE -->
            <div class="section" id="database">
                <h2 class="section-title">üóÑÔ∏è 5. Struttura Database (Google Sheet)</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">TAB Principali</h3>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>TAB</th>
                                <th>Colonne Chiave</th>
                                <th>Descrizione</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Clienti</strong></td>
                                <td>A: ID_Cliente<br>B: Nome_Cliente<br>I: Email</td>
                                <td>Anagrafica clienti completa</td>
                            </tr>
                            <tr>
                                <td><strong>Timesheet</strong></td>
                                <td>A: ID_Intervento<br>B: ID_Cliente<br>C: Nome_Cliente<br>E: Data<br>K: Durata_Ore<br>M: Mod_Addebito<br>Q: Costo_Finale</td>
                                <td>Log interventi con modalit√† addebito</td>
                            </tr>
                            <tr>
                                <td><strong>Pacchetti</strong></td>
                                <td>A: ID_Pacchetto<br>B: ID_Cliente<br>E: Ore_Acquistate<br>F: Ore_Utilizzate<br>G: Ore_Residue (formula)<br>J: STATO (formula)</td>
                                <td>Pacchetti ore con formule automatiche</td>
                            </tr>
                            <tr>
                                <td><strong>Canoni</strong></td>
                                <td>A: ID_Canone (CA_YYYY_###)<br>B: ID_Precedente<br>C: ID_Cliente<br>D: Nome_Cliente<br>F: Data_Inizio<br>G: Data_Scadenza<br>I: STATO<br>L: Event_ID</td>
                                <td>Canoni con tracking storico rinnovi</td>
                            </tr>
                            <tr>
                                <td><strong>Firme</strong></td>
                                <td>A: ID_Firma (FD_YYYY_###)<br>B: ID_Precedente<br>E: Tipo (Token/Remota)<br>G: Data_Scadenza<br>I: STATO<br>L: Event_ID</td>
                                <td>Firme digitali con durata 3 anni</td>
                            </tr>
                            <tr>
                                <td><strong>RIF</strong></td>
                                <td>Config_Sheet con opzioni Tipo_Intervento, Mod_Esecuzione, Mod_Addebito</td>
                                <td>Configurazioni e riferimenti</td>
                            </tr>
                            <tr>
                                <td><strong>System_Log</strong></td>
                                <td>A: Timestamp<br>B: Level<br>C: Action<br>D: Message</td>
                                <td>Log completo sistema</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="warning-box">
                    <h4 style="margin-bottom: 10px;">‚ö†Ô∏è Colonne con Formule Automatiche</h4>
                    <p><strong>Pacchetti - Colonna G (Ore_Residue):</strong><br>
                    <code>=E2-F2</code> (Ore_Acquistate - Ore_Utilizzate)</p>
                    <p style="margin-top: 10px;"><strong>Pacchetti - Colonna J (STATO):</strong><br>
                    Formula complessa che determina: ATTIVO / TERMINATO / OVER / SCADUTO</p>
                    <p style="margin-top: 10px;">‚ö†Ô∏è <strong>NON scrivere manualmente in queste colonne</strong> - sono gestite da formule!</p>
                </div>
            </div>

            <!-- FLUSSI -->
            <div class="section" id="flows">
                <h2 class="section-title">üîÑ 6. Flussi Operativi Principali</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">üìù Flusso Inserimento Timesheet</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #28a745; font-family: monospace; white-space: pre-wrap; font-size: 0.9rem;">
1. User compila form timesheet (data, cliente, ore, modalit√†)
2. Frontend valida dati
3. POST ‚Üí doPost(action=insert_timesheet)
4. Backend valida cliente (validateClient)
5. Backend cerca pacchetto ATTIVO (getActivePacchetto)
   
   SE Mod_Addebito = "Pacchetto Ore":
      5a. Scala ore da pacchetto (updatePacchetto)
      5b. Verifica stato ‚Üí ATTIVO/TERMINATO/OVER
      5c. Se OVER/TERMINATO ‚Üí genera alert + email
   
6. Inserisce riga in Timesheet
7. Scrive log
8. Ritorna success + eventuali alert
9. Frontend mostra conferma/alert
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üí∞ Flusso Vendita Canone</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #667eea; font-family: monospace; white-space: pre-wrap; font-size: 0.9rem;">
1. User compila form vendita canone
2. Frontend valida (cliente, importo, date)
3. GET ‚Üí doGet(action=insert_canone)
4. Backend:
   4a. Valida cliente
   4b. Genera ID_Canone (CA_2025_001)
   4c. Calcola Data_Scadenza (Data_Inizio + durata_anni)
   4d. Crea evento Google Calendar con alert -30/-7gg
   4e. Inserisce riga in TAB Canoni con Event_ID
   4f. Scrive log
5. Email conferma automatica
6. Frontend mostra success
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üîÑ Flusso Rinnovo Canone</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #ffc107; font-family: monospace; white-space: pre-wrap; font-size: 0.9rem;">
1. Sistema identifica canoni in scadenza (< 90gg)
2. User apre sezione Rinnovi
3. Visualizza lista canoni rinnovabili
4. Click "Rinnova" ‚Üí modal con dati modificabili
5. Conferma ‚Üí GET action=rinnova_canone
6. Backend:
   6a. Recupera vecchio canone
   6b. Crea nuovo canone con:
       - ID_Precedente = CA_vecchio
       - Data_Inizio = giorno dopo scadenza vecchia
       - Nuovo Event_ID Calendar
   6c. Aggiorna vecchio STATO ‚Üí SCADUTO
   6d. Elimina vecchio evento Calendar
7. Ritorna nuovo ID_Canone
8. Frontend mostra success con link nuovo canone
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üìß Flusso Email Scadenze (Trigger Giornaliero)</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #dc3545; font-family: monospace; white-space: pre-wrap; font-size: 0.9rem;">
TRIGGER: Ogni giorno ore 8:00
Funzione: checkScadenzeGiornaliero()

1. Controlla FIRME:
   Per ogni firma ATTIVA:
   - Se mancano 30gg ‚Üí Email SOLO al cliente
   - Se mancano 10gg ‚Üí Email al cliente + Giuseppe
   
2. Controlla PACCHETTI:
   Per ogni pacchetto SCADUTO (flag email non inviata):
   - Invia email alert a Giuseppe
   - Segna flag "Email inviata" (colonna N)

3. Log completo operazioni
4. In caso errore ‚Üí email a Giuseppe
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üìÑ Flusso Generazione Proforma</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #17a2b8; font-family: monospace; white-space: pre-wrap; font-size: 0.9rem;">
1. User seleziona cliente
2. Frontend recupera timesheet "Da fatturare"
3. User seleziona interventi + causale + quota 4%
4. Click "Genera" ‚Üí POST action=generate_proforma
5. Backend:
   5a. Genera numero proforma (N/YYYY)
   5b. Recupera dati cliente completi
   5c. Copia template da Google Docs
   5d. Compila celle (cliente, data, causale, importi)
   5e. Calcola subtotale + quota integrativa
   5f. Converte in PDF
   5g. Salva in cartella "- PROFORMA"
   5h. Aggiorna timesheet: Mod_Addebito ‚Üí "Proformato"
6. Ritorna URL PDF
7. Frontend mostra preview + bottone "Invia Email"
8. User invia email ‚Üí allegato PDF automatico
                    </div>
                </div>
            </div>

            <!-- API ENDPOINTS -->
            <div class="section" id="api">
                <h2 class="section-title">üåê 7. API Endpoints</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">üìç Endpoints Disponibili (50+)</h3>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Action</th>
                                <th>Metodo</th>
                                <th>Parametri</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td rowspan="3"><strong>Utilities</strong></td>
                                <td>test_connection</td>
                                <td>GET</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>get_logs</td>
                                <td>GET</td>
                                <td>limit (default 100)</td>
                            </tr>
                            <tr>
                                <td>check_integrity</td>
                                <td>GET</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td rowspan="4"><strong>Clienti</strong></td>
                                <td>get_data</td>
                                <td>GET</td>
                                <td>- (ritorna clients + config)</td>
                            </tr>
                            <tr>
                                <td>add_client</td>
                                <td>GET</td>
                                <td>client_name, client_email</td>
                            </tr>
                            <tr>
                                <td>update_client</td>
                                <td>GET</td>
                                <td>id_cliente, campo, valore</td>
                            </tr>
                            <tr>
                                <td>delete_client</td>
                                <td>GET</td>
                                <td>id_cliente</td>
                            </tr>
                            <tr>
                                <td rowspan="2"><strong>Timesheet</strong></td>
                                <td>insert_timesheet</td>
                                <td>POST</td>
                                <td>id_cliente, data, tipo, ore, mod_addebito...</td>
                            </tr>
                            <tr>
                                <td>get_timesheet_da_fatturare</td>
                                <td>GET</td>
                                <td>client_name</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Proforma</strong></td>
                                <td>generate_proforma</td>
                                <td>GET</td>
                                <td>client_name, timesheet_ids, causale, applica_quota</td>
                            </tr>
                            <tr>
                                <td>get_proforma_details</td>
                                <td>GET</td>
                                <td>n_proforma</td>
                            </tr>
                            <tr>
                                <td>send_proforma_email</td>
                                <td>GET</td>
                                <td>n_proforma, client_email, subject, body</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Pacchetti</strong></td>
                                <td>insert_pacchetto</td>
                                <td>GET</td>
                                <td>cliente_nome, ore_totali, importo, data_inizio</td>
                            </tr>
                            <tr>
                                <td>get_pacchetti_scaduti</td>
                                <td>GET</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>get_active_pacchetto</td>
                                <td>GET</td>
                                <td>id_cliente</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Canoni</strong></td>
                                <td>insert_canone</td>
                                <td>GET</td>
                                <td>cliente_nome, importo, data_inizio, durata_anni</td>
                            </tr>
                            <tr>
                                <td>get_canoni_in_scadenza</td>
                                <td>GET</td>
                                <td>giorni (default 90)</td>
                            </tr>
                            <tr>
                                <td>update_stato_canone</td>
                                <td>GET</td>
                                <td>id_canone, nuovo_stato</td>
                            </tr>
                            <tr>
                                <td rowspan="3"><strong>Firme</strong></td>
                                <td>insert_firma</td>
                                <td>GET</td>
                                <td>cliente_nome, tipo, importo, data_inizio</td>
                            </tr>
                            <tr>
                                <td>get_firme_in_scadenza</td>
                                <td>GET</td>
                                <td>giorni (default 90)</td>
                            </tr>
                            <tr>
                                <td>update_stato_firma</td>
                                <td>GET</td>
                                <td>id_firma, nuovo_stato</td>
                            </tr>
                            <tr>
                                <td rowspan="4"><strong>Rinnovi</strong></td>
                                <td>rinnova_canone</td>
                                <td>GET</td>
                                <td>id_canone_vecchio, nuovi_dati</td>
                            </tr>
                            <tr>
                                <td>rinnova_firma</td>
                                <td>GET</td>
                                <td>id_firma_vecchia, nuovi_dati</td>
                            </tr>
                            <tr>
                                <td>get_storico_rinnovi</td>
                                <td>GET</td>
                                <td>id_prodotto, tipo</td>
                            </tr>
                            <tr>
                                <td>get_tutti_prodotti_in_scadenza</td>
                                <td>GET</td>
                                <td>giorni (default 90)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="info-box">
                    <h4 style="margin-bottom: 10px;">üîí Autenticazione</h4>
                    <p>Il Web App √® deployed con permessi <code>Anyone</code> per consentire accesso esterno. OAuth 2.0 configurato per Calendar e Drive API.</p>
                </div>
            </div>

            <!-- CHANGELOG -->
            <div class="section" id="changelog">
                <h2 class="section-title">üìù 8. Changelog v3.0 ‚Üí v3.7</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">üÜï Novit√† Versione 3.7 (Ottobre 2025)</h3>
                    
                    <div class="success-box">
                        <h4>‚úÖ Sistema Vendite Completo</h4>
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ Canoni con Calendar integration</li>
                            <li>‚úÖ Firme Digitali (Token/Remota) con durata 3 anni</li>
                            <li>‚úÖ Pacchetti ore con formule automatiche STATO</li>
                            <li>‚úÖ Generazione ID automatica (CA_YYYY_###, FD_YYYY_###)</li>
                        </ul>
                    </div>

                    <div class="success-box">
                        <h4>‚úÖ Sistema Rinnovi Automatici</h4>
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ Tracking storico con ID_Precedente</li>
                            <li>‚úÖ Modifica importi durante rinnovo</li>
                            <li>‚úÖ Gestione automatica vecchi Eventi Calendar</li>
                            <li>‚úÖ Validazione: solo prodotti ATTIVI rinnovabili</li>
                        </ul>
                    </div>

                    <div class="success-box">
                        <h4>‚úÖ Sistema Email Scadenze (Trigger)</h4>
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ Trigger giornaliero ore 8:00</li>
                            <li>‚úÖ Email firme: 30gg (cliente) + 10gg (cliente + Giuseppe)</li>
                            <li>‚úÖ Email pacchetti SCADUTI a Giuseppe</li>
                            <li>‚úÖ Template HTML professionali</li>
                            <li>‚úÖ Log completo invii</li>
                        </ul>
                    </div>

                    <div class="success-box">
                        <h4>‚úÖ Google Calendar Integration</h4>
                        <ul style="margin-left: 20px;">
                            <li>‚úÖ Eventi automatici per ogni vendita</li>
                            <li>‚úÖ Alert programmati multi-livello</li>
                            <li>‚úÖ Update/Delete eventi su modifica/cancellazione</li>
                            <li>‚úÖ Event_ID salvato in DB per tracking</li>
                        </ul>
                    </div>

                    <div class="warning-box">
                        <h4>üîß Miglioramenti Tecnici</h4>
                        <ul style="margin-left: 20px;">
                            <li>‚Ä¢ Validazione cliente centralizzata (validateClient)</li>
                            <li>‚Ä¢ Sistema log migliorato (writeLog con metadata)</li>
                            <li>‚Ä¢ Error handling robusto su tutte le API</li>
                            <li>‚Ä¢ Frontend refactoring modulare</li>
                            <li>‚Ä¢ CSS separati per componente</li>
                        </ul>
                    </div>

                    <div class="info-box">
                        <h4>üìä Metriche Sistema v3.7</h4>
                        <div class="grid">
                            <div class="stats-box">
                                <div class="stats-number">15</div>
                                <div class="stats-label">TAB Database</div>
                            </div>
                            <div class="stats-box">
                                <div class="stats-number">50+</div>
                                <div class="stats-label">API Endpoints</div>
                            </div>
                            <div class="stats-box">
                                <div class="stats-number">~400</div>
                                <div class="stats-label">Funzioni Backend</div>
                            </div>
                            <div class="stats-box">
                                <div class="stats-number">100%</div>
                                <div class="stats-label">Mobile Ready</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üìÖ Timeline Sviluppo</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Versione</th>
                                <th>Data</th>
                                <th>Milestone</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>v1.0</strong></td>
                                <td>-</td>
                                <td>Sistema base Timesheet + Pacchetti + Proforma</td>
                            </tr>
                            <tr>
                                <td><strong>v2.0</strong></td>
                                <td>-</td>
                                <td>Refactoring frontend, PWA, gestione clienti migliorata</td>
                            </tr>
                            <tr>
                                <td><strong>v3.0</strong></td>
                                <td>Gennaio 2025</td>
                                <td>Piano sviluppo vendite + calendar (documentato)</td>
                            </tr>
                            <tr>
                                <td><strong>v3.1-3.6</strong></td>
                                <td>Gen-Ott 2025</td>
                                <td>Implementazione incrementale funzionalit√† v3.0</td>
                            </tr>
                            <tr>
                                <td><strong>v3.7</strong></td>
                                <td>31 Ottobre 2025</td>
                                <td>Sistema completo vendite + rinnovi + email automatiche</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- QUICK REFERENCE -->
            <div class="section" id="quickref">
                <h2 class="section-title">‚ö° 9. Quick Reference</h2>
                
                <div class="subsection">
                    <h3 class="subsection-title">üéØ Per Iniziare Nuove Chat</h3>
                    
                    <div class="success-box">
                        <h4>üìã Copia-Incolla questo per nuove conversazioni:</h4>
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px; border: 2px solid #28a745; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap;">
üöÄ <strong>CRM STUDIO SMART - v3.7</strong>

<strong>SISTEMA:</strong> Google Apps Script + Google Sheets + PWA Frontend
<strong>STACK:</strong> Vanilla JS, HTML5, CSS3 (mobile-first)
<strong>DATABASE:</strong> Google Sheet (1aSNuc5fzkgUERsJ6pNPn-Rkte3SJMcksHNicCu8T2yQ)

<strong>BACKEND (15 file .gs, ~6.440 righe):</strong>
- Codice.gs (router principale, doGet/doPost)
- Clienti.gs, Timesheet.gs, Pacchetti.gs
- Canoni.gs, Firme.gs, Rinnovi.gs
- Calendar.gs, Email.gs, EmailScadenze.gs
- Proforma.gs, Trigger.gs, Utilities.gs
- Helpers.gs, Config.gs

<strong>FRONTEND (9 file .js, ~3.041 righe):</strong>
- index.html (unico file HTML)
- main.js, api.js, config.js
- clienti.js, timesheet.js, vendite.js
- proforma.js, utilities.js, utils.js
+ 9 file CSS modulari

<strong>FUNZIONALIT√Ä PRINCIPALI:</strong>
‚úÖ Gestione clienti (CRUD)
‚úÖ Timesheet con pacchetti ore
‚úÖ Vendite: Canoni, Firme, Pacchetti
‚úÖ Proforma automatiche (template + PDF)
‚úÖ Google Calendar integration (scadenze)
‚úÖ Rinnovi automatici con storico (ID_Precedente)
‚úÖ Email automatiche scadenze (trigger ore 8:00)
‚úÖ Sistema log completo

<strong>TAB DATABASE:</strong>
- Clienti, Timesheet, Pacchetti
- Canoni (CA_YYYY_###), Firme (FD_YYYY_###)
- RIF (config), System_Log

<strong>TRIGGER:</strong>
Giornaliero ore 8:00 ‚Üí checkScadenzeGiornaliero()
- Firme: email 30gg (cliente) + 10gg (cliente+Giuseppe)
- Pacchetti SCADUTI: alert Giuseppe

<strong>FILE DISPONIBILI:</strong>
[Link documento HTML completo: CRM_Studio_Smart_RIEPILOGO_v3-7.html]
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">üîë Comandi Utili</h3>
                    
                    <div class="grid">
                        <div class="card">
                            <div class="card-title">üìÇ Accesso Files</div>
                            <div class="card-content">
                                <strong>Google Sheet:</strong><br>
                                <code style="font-size: 0.7rem;">1aSNuc5fzkgUERsJ6pNPn-Rkte3SJMcksHNicCu8T2yQ</code><br><br>
                                <strong>Apps Script:</strong><br>
                                script.google.com ‚Üí Progetto CRM
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">üß™ Test API</div>
                            <div class="card-content">
                                <code style="font-size: 0.75rem;">?action=test_connection</code><br>
                                <code style="font-size: 0.75rem;">?action=get_logs&limit=50</code><br>
                                <code style="font-size: 0.75rem;">?action=check_integrity</code>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">üìß Email Config</div>
                            <div class="card-content">
                                <strong>From:</strong> info@studio-smart.it<br>
                                <strong>Quota:</strong> 100/day (free)<br>
                                <strong>Trigger:</strong> 8:00 giornaliero
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">üîß Manutenzione</div>
                            <div class="card-content">
                                ‚Ä¢ Backup: generate_backup()<br>
                                ‚Ä¢ Clean logs: clean_logs(30)<br>
                                ‚Ä¢ Check trigger: Script Editor ‚Üí Triggers
                            </div>
                        </div>
                    </div>
                </div>

                <div class="warning-box">
                    <h4 style="margin-bottom: 10px;">‚ö†Ô∏è Note Importanti</h4>
                    <ul style="margin-left: 20px;">
                        <li><strong>Non modificare manualmente</strong> colonne con formule (Pacchetti: Ore_Residue, STATO)</li>
                        <li><strong>Validare sempre cliente</strong> prima di operazioni (validateClient obbligatorio)</li>
                        <li><strong>Event_ID Calendar</strong> va salvato per permettere delete/update eventi</li>
                        <li><strong>ID_Precedente</strong> crea la catena storica rinnovi - non cancellare</li>
                        <li><strong>Trigger email</strong> verifica quota giornaliera (100 email/day su account free)</li>
                    </ul>
                </div>

                <div class="info-box">
                    <h4 style="margin-bottom: 10px;">üìö Documentazione Completa</h4>
                    <p>Questo documento HTML contiene l'intera architettura, tutti i file, funzioni, flussi e API endpoints del sistema CRM v3.7.</p>
                    <p style="margin-top: 10px;"><strong>Usa questo file come riferimento</strong> per:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Iniziare nuove chat con Claude fornendo il contesto completo</li>
                        <li>Onboarding nuovi sviluppatori</li>
                        <li>Debugging e troubleshooting</li>
                        <li>Pianificazione evolutive future</li>
                    </ul>
                </div>
            </div>

            <!-- FOOTER -->
            <div style="margin-top: 60px; padding: 30px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Sistema Pronto per Sviluppi v4.0</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Documentazione aggiornata al <strong>31 Ottobre 2025</strong><br>
                    Versione CRM: <strong>3.7</strong> | Backend: <strong>~6.440 righe</strong> | Frontend: <strong>~3.041 righe</strong>
                </p>
                <div style="margin-top: 20px;">
                    <span class="badge badge-success">‚úÖ OPERATIVO</span>
                    <span class="badge badge-info">üì± MOBILE-READY</span>
                    <span class="badge badge-primary">üîÑ AGGIORNATO</span>
                </div>
            </div>

        </div>
    </div>
</body>
</html>
